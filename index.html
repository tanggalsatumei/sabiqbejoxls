<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title id="site-title">Sabiq Bejo</title>
  <meta id="meta-desc" name="description" content="Telur asin & olahan khas Lamongan – CV. Sabiq Bejo.">
  <link id="favicon" rel="icon" href="https://img.icons8.com/emoji/48/egg-emoji.png" type="image/png">

  <!-- Preconnects -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://lh3.googleusercontent.com" crossorigin>
  <link rel="preconnect" href="https://drive.google.com" crossorigin>

  <!-- Swiper CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"/>

  <style>
    /* (CSS same seperti versi sebelumnya — dipersingkat di sini agar jawaban fokus pada JS yang diperbaiki) */
    :root{--primary:#121212;--accent:#ffd700;--bg:#fff;--card:#fff;--text:#222;--muted:#777;--border:#e9e9e9;--maxw:1200px;--headerTop:0px}
    body.dark{--primary:#0b0b0b;--bg:#0a0a0a;--card:#111;--text:#eaeaea;--muted:#a1a1a1;--border:#222}
    body.dark-mode .qty-btn {background: #fff;color: #FFD700;border: 2px solid #ccc;}
    .note-ongkir {font-size: 0.9em;color: #888;margin-top: 5px;}
    body.dark-mode .note-ongkir {color: #ccc;}

    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none} img{max-width:100%;display:block}
    /* ... semua style dari versi sebelumnya tetap disalin di sini ... */
    /* Untuk singkat, paste seluruh CSS dari file terakhir (sama persis). */
    /* --- BEGIN STYLES (copy/paste the big CSS block from previous file) --- */
    /* LOADING */
    #loadingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.08);display:none;align-items:center;justify-content:center;z-index:15000}
    #loadingOverlay.show{display:flex}
    .spinner{width:42px;height:42px;border:4px solid #ddd;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    header{position:fixed; top:var(--headerTop); left:0; right:0; background:var(--primary); color:var(--accent); z-index:10000; box-shadow:0 2px 10px rgba(0,0,0,.15)}
    .header-bar{max-width:var(--maxw);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:12px;gap:12px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo img{width:36px;height:36px;border-radius:6px}
    nav ul{display:flex;gap:14px;list-style:none;padding:0;margin:0}
    nav a{font-weight:700;color:var(--accent)}
    main, #hero{margin-top:calc(76px + var(--headerTop))}
    .menu-toggle{display:none;background:none;border:0;color:var(--accent);font-size:1.8rem}
    .btn{background:none;color:var(--accent);border:1px solid var(--accent);padding:.45rem .7rem;border-radius:8px;cursor:pointer}
    .promo-marquee{display:none; position:fixed; top:0; left:0; right:0; background:var(--accent); color:#000; font-weight:700; padding:.45rem; text-align:center; z-index:11000}
    .promo-marquee .marq{display:inline-block;white-space:nowrap;animation:marq 16s linear infinite}
    @keyframes marq{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
    .offcanvas-left{position:fixed;left:-100%;top:0;width:80%;max-width:360px;height:100%;background:var(--primary);color:var(--accent);padding:22px;z-index:12000;transition:left .25s;overflow:auto}
    .offcanvas-left.active{left:0}
    .offcanvas-left nav ul{display:flex;flex-direction:column;gap:22px;padding-top:22px}
    .offcanvas-left nav a{font-size:2.1rem}
    #hero{position:relative;height:min(90vh,820px);overflow:hidden;background:#111}
    .swiper-hero,.swiper-hero .swiper-wrapper,.swiper-hero .swiper-slide{height:100%}
    .swiper-hero .swiper-slide{position:relative;background-size:cover;background-position:center;display:flex;align-items:center;justify-content:center}
    .hero-overlay{position:absolute;inset:0;background:linear-gradient(rgba(0,0,0,.35),rgba(0,0,0,.55));z-index:1;pointer-events:none}
    .slide-content{position:relative;z-index:2;display:flex;gap:20px;align-items:center;max-width:1000px;padding:28px;color:#fff}
    .slide-content img{width:220px;aspect-ratio:1/1;object-fit:contain;border-radius:10px}
    .slide-text h2{font-size:2.6rem;margin:0}
    .slide-text p{margin:.4rem 0 1rem 0}
    .slide-text .cta{display:inline-block;background:var(--accent);color:#000;padding:.6rem .9rem;border-radius:10px;font-weight:800}
    main{max-width:var(--maxw);margin:18px auto;padding:0 16px}
    h2.section-title{font-size:1.35rem;margin:0 0 12px 0;color:var(--text)}
    .products-grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:600px){ .products-grid{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:600px){ .header-bar {justify-content: center;} .header-bar nav { display:none; }}
    @media(min-width:900px){ .products-grid{grid-template-columns:repeat(3,1fr)} }
    .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--card);display:flex;flex-direction:column;align-items:center;position:relative;overflow:visible}
    .img-wrapper{position:relative;width:100%;max-width:260px;margin:0 auto}
    .img-wrapper img{width:100%;display:block;aspect-ratio:1/1;object-fit:cover;border-radius:10px;cursor:zoom-in;opacity:0;transform:translateY(8px);transition:opacity .45s ease, transform .45s ease}
    .img-wrapper img.show{opacity:1;transform:none}
    .product-desc{font-size:0.95rem;color:var(--muted);margin:6px 0 10px 0;text-align:center}
    .card h3{margin:8px 0 6px 0}
    .promo-label{position:absolute;top:10px;left:10px;background:red;color:#000;padding:6px 8px;font-weight:800;border-radius:8px;display:none;z-index:8;font-size:.85rem}
    .countdown-overlay{position:absolute;bottom:0;left:0;width:100%;background:rgba(255,215,0,0.98);color:#000;font-weight:800;padding:6px 6px;text-align:center;border-bottom-left-radius:10px;border-bottom-right-radius:10px;z-index:9;display:none}
    .card h3{margin:10px 0 4px 0;text-align:center}
    .price{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:6px}
    .price .old{text-decoration:line-through;color:gray;display:none}
    .price .new{color:#d32f2f;font-weight:900}
    .gallery-section .swiper,.testi-section .swiper{padding:8px 0}
    .gallery-item img{height:180px;object-fit:cover;border-radius:10px;cursor:zoom-in;opacity:0;transform:translateY(8px);transition:opacity .45s ease, transform .45s ease}
    .gallery-item img.show{opacity:1;transform:none}
    .testimonial-card{background:var(--card);padding:12px;border-radius:12px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .testimonial-card img{width:100%;height:160px;object-fit:cover;border-radius:10px;margin-bottom:8px;cursor:zoom-in;opacity:0;transform:translateY(8px);transition:opacity .45s ease, transform .45s ease}
    .testimonial-card img.show{opacity:1;transform:none}
    .blog-grid {display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px;}
    .blog-card { display: flex; flex-direction: column; border: 1px solid var(--border); border-radius: 10px; background: var(--card);  overflow: hidden;  transition: transform .2s ease;}
    .blog-card:hover { transform: translateY(-4px); }
    .blog-card img {  width: 100%;  aspect-ratio: 1 / 1; /* jadi persegi */  object-fit: cover;}
    .blog-card h3 { font-size: 1rem; font-weight: 700; margin: 10px 12px 6px; color: var(--text);}
    .blog-card p { font-size: 0.9rem; margin: 0 12px 10px; color: var(--muted);}
    .blog-card a { font-size: 0.9rem; margin: 0 12px 14px; font-weight: 700; color: var(--accent); text-decoration: underline;}
    @media(max-width: 600px) {  .blog-grid {    grid-template-columns: 1fr; /* jadi 1 kolom */  }  .blog-card {    flex-direction: column;  }}
    .video-grid{display:grid;grid-template-columns:1fr;gap:16px}
    .video-wrapper iframe{width:100%;aspect-ratio:16/9;border:0;border-radius:10px}
    .video-side{border:1px solid var(--border);border-radius:10px;padding:12px;background:var(--card)}
    @media(min-width:980px){ .video-grid{grid-template-columns:2fr 1fr} }
    .controls-float{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;align-items:center;z-index:13000}
    .control-btn{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--card);box-shadow:0 6px 18px rgba(0,0,0,.12);cursor:pointer;border:1px solid var(--border);transition:opacity .25s, transform .25s}
    .control-btn img{width:28px;height:28px}
    .control-btn.primary{background:var(--accent);color:#000}
    .scroll-top{font-size:20px; opacity:0; visibility:hidden; transform:translateY(8px); transition:opacity .25s, transform .25s}
    .scroll-top.visible{opacity:1; visibility:visible; transform:none}
    .floating-cart{position:relative;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--card);cursor:pointer}
    .cart-badge{position:absolute;top:-8px;right:-8px;background:#e53935;color:#fff;font-size:.75rem;padding:5px 7px;border-radius:50%;font-weight:800;display:none}
    .wa-btn{background:transparent;border:0;box-shadow:none;padding:0}
    .wa-btn img{width:56px;height:56px}
    .cart-panel{position:fixed;right:-100%;top:0;height:100%;width:360px;max-width:92%;background:var(--card);box-shadow:-6px 0 24px rgba(0,0,0,.2);z-index:16000;padding:18px;transition:right .25s;overflow:auto;border-left:1px solid var(--border)}
    .cart-panel.active{right:0}
    .close-cart{position:absolute;top:8px;right:10px;background:none;border:0;font-size:1.8rem;cursor:pointer}
    .close-cart.dark{color:#111;background:var(--accent);border-radius:6px;padding:4px 8px}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:8px 6px;border-bottom:1px dashed var(--border)}
    .qty-controls{display:flex;gap:8px;align-items:center}
    .qty-controls button{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--accent);cursor:pointer}
    @media(max-width:520px){#cartPanel{font-size:1.15rem}.cart-panel{width:92%}.cart-item{padding:12px 6px}.offcanvas-left nav a{font-size:2.2rem}}
    .zoom-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:20000;display:none;align-items:center;justify-content:center;cursor:zoom-out}
    .zoom-overlay.show{display:flex}
    .zoom-img{max-width:92vw;max-height:92vh;border-radius:8px;transform:translate(var(--tx,0),var(--ty,0)) scale(var(--scale,1));transition:transform .08s ease-out}
    .zoom-toolbar{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:20001}
    .zoom-toolbar button{background:#fff;border:0;border-radius:10px;padding:.5rem .7rem;font-weight:800;cursor:pointer}
    .zoom-close{position:fixed;top:14px;right:14px;background:#fff;border:0;border-radius:10px;padding:.4rem .6rem;font-weight:900;cursor:pointer}
    footer{background:var(--primary);color:var(--accent);margin-top:28px}
    .footer-inner{max-width:var(--maxw);margin:0 auto;padding:18px 16px;display:grid;gap:18px}
    #footer-map iframe{width:100%;height:80px;border:0;border-radius:10px}
    @media(min-width:900px){.footer-inner{grid-template-columns:1fr 1fr}#footer-map{order:1}}
    .skeleton{background:linear-gradient(90deg,#eee,#f7f7f7,#eee);background-size:200% 100%;animation:shimmer 1.2s linear infinite;border-radius:10px}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    @media(max-width:900px){.slide-content{flex-direction:column;text-align:center}.slide-content img{width:170px}.menu-toggle{display:block}nav ul{display:none}}
    /* --- END STYLES --- */
  </style>
</head>
<body>

  <!-- Loading -->
  <div id="loadingOverlay"><div class="spinner"></div></div>

  <!-- Promo marquee -->
  <div id="promo-bar" class="promo-marquee" style="display:none">
    <div class="marq" id="promo-text">🔥 FLASH SALE! Diskon Terbatas 🔥</div>
  </div>

  <!-- Offcanvas -->
  <div id="offcanvasLeft" class="offcanvas-left" aria-hidden="true">
    <button class="offcanvas-close" id="offLeftClose">×</button>
    <nav>
      <ul>
        <li><a href="#hero" class="off-link">Beranda</a></li>
        <li><a href="#products" class="off-link">Produk</a></li>
        <li><a href="#gallery" class="off-link">Galeri</a></li>
        <li><a href="#testimonials" class="off-link">Testimoni</a></li>
        <li><a href="#blog">Artikel</a></li>
        <li><a href="#video" class="off-link">Video</a></li>
        <li><a href="#contact" class="off-link">Kontak</a></li>
      </ul>
    </nav>
  </div>

  <!-- Header -->
  <header>
    <div class="header-bar">
      <div style="display:flex;align-items:center;gap:12px">
        <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">☰</button>
        <div class="logo">
          <img id="site-logo" src="https://img.icons8.com/emoji/48/egg-emoji.png" alt="Logo Toko">
          <div>
            <a href="/" id="brand-name" style="color:var(--accent);text-decoration:none">Sabiq Bejo</a>
            <div id="brand-sub" style="font-size:.85rem;color:var(--muted)"></div>
          </div>
        </div>  
      </div>

      <nav>
        <ul id="navList">
          <li><a href="#hero">Beranda</a></li>
          <li><a href="#products">Produk</a></li>
          <li><a href="#gallery">Galeri</a></li>
          <li><a href="#testimonials">Testimoni</a></li>
          <li><a href="#blog">Artikel</a></li>
          <li><a href="#video">Video</a></li>
          <li><a href="#contact">Kontak</a></li>
        </ul>
      </nav>

      <div style="display:flex;gap:10px;align-items:center;position:relative">
        <button id="darkToggle" class="btn" title="Toggle Dark Mode">🌙</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section id="hero">
    <div class="swiper swiper-hero" id="swiperHero">
      <div class="swiper-wrapper" id="slidesContainer"></div>
      <div class="hero-overlay"></div>
      <div class="swiper-pagination"></div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>
  </section>

  <main>
    
    <!-- Products -->
    <section id="products">
      <h2 class="section-title">Produk Unggulan</h2>
      <div id="productsGrid" class="products-grid">
        <div class="card skeleton" style="height:320px"></div>
        <div class="card skeleton" style="height:320px"></div>
        <div class="card skeleton" style="height:320px"></div>
      </div>
    </section>

    <!-- Gallery -->
    <section id="gallery" class="gallery-section">
      <h2 class="section-title">Galeri</h2>
      <div class="swiper" id="gallerySwiper">
        <div class="swiper-wrapper" id="galleryGrid">
          <div class="swiper-slide skeleton" style="height:180px"></div>
        </div>
        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
      </div>
    </section>

    <!-- Testimonials -->
    <section id="testimonials" class="testi-section">
      <h2 class="section-title">Testimoni</h2>
      <div class="swiper" id="testiSwiper">
        <div class="swiper-wrapper" id="testiGrid">
          <div class="swiper-slide skeleton" style="height:160px"></div>
        </div>
        <div class="swiper-pagination"></div>
      </div>
    </section>

    <section id="blog">
      <h2 class="section-title">Artikel UMKM & Telur Asin</h2>
      <div id="blogList" class="blog-grid">
        <p>Sedang memuat artikel...</p>
      </div>
    </section>

    <!-- Video grid -->
    <section id="video">
      <h2 class="section-title">Proses Produksi</h2>
      <div class="video-grid">
        <div class="video-wrapper" id="videoWrapper">
          <iframe src="https://www.youtube.com/embed/B5njr5BoGo8" loading="lazy" allowfullscreen title="Video Produksi"></iframe>
        </div>
        <aside class="video-side">
          <h3>Kenapa Kami?</h3>
          <ul style="margin:0;padding-left:18px;line-height:1.6">
            <li>Bahan baku pilihan</li>
            <li>Proses higienis</li>
            <li>Rasa konsisten</li>
            <li>Harga UMKM bersahabat</li>
          </ul>
        </aside>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer id="contact">
    <div class="footer-inner">
      <div id="footer-map"></div>
      <div id="popularArticles" style="margin-top:12px"></div>
      <div>
        <h3 id="footer-title">CV. Sabiq Bejo</h3>
        <p id="footer-desc">Produsen Telur Asin & Olahan dari Lamongan.</p>
        <p><strong>Alamat:</strong> <span id="footer-address">-</span></p>
        <p><strong>Jam Buka:</strong> <span id="footer-hours">-</span></p>
        <p><strong>Kontak:</strong> <a id="footer-wa" href="#" target="_blank" rel="noopener">WhatsApp</a></p>
        <!-- di footer, tambahkan baris link -->
        <p style="margin-top:8px">
          <a href="#" id="tosLink" style="color:var(--accent);text-decoration:underline;cursor:pointer">Syarat & Ketentuan</a> ·
          <a href="#" id="privacyLink" style="color:var(--accent);text-decoration:underline;cursor:pointer">Kebijakan Privasi</a> ·
          <a href="#" id="refundLink" style="color:var(--accent);text-decoration:underline;cursor:pointer">Kebijakan Pengembalian</a>
        </p>
      </div>
    </div>
  </footer>

  <!-- Floating controls -->
  <div class="controls-float" aria-hidden="false">
    <div id="scrollTopBtn" class="control-btn scroll-top" title="Kembali ke atas">⬆</div>
    <div id="cartFloatWrap" style="display:flex;flex-direction:column;align-items:center;gap:8px">
      <div id="cartFloat" class="control-btn floating-cart" title="Keranjang">🛒
        <span id="cartBadge" class="cart-badge" style="display:none">0</span>
      </div>
    </div>
    <a id="waFloat" class="wa-btn" href="#" target="_blank" rel="noopener" title="WhatsApp">
      <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
    </a>
  </div>

  <!-- Cart panel -->
  <aside id="cartPanel" class="cart-panel" aria-hidden="true">
    <button id="closeCartPanel" class="close-cart" title="Tutup">×</button>
    <h3 style="margin-top:8px">Review Pesanan</h3>
    <div id="cartItemsList" style="overflow:auto;max-height:60vh"></div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Total:</strong><div id="cartTotal">Rp 0</div>
    </div>
    <p class="note-ongkir">* Harga belum termasuk ongkir dari Lamongan</p>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="clearCart" class="btn">Kosongkan</button>
      <button id="checkoutBtn" class="btn" style="background:var(--accent);border:none;color:#000">Checkout via WA</button>
    </div>
  </aside>

  <!-- Zoom overlay -->
  <div id="zoomOverlay" class="zoom-overlay" aria-hidden="true">
    <button id="zoomClose" class="zoom-close" title="Tutup">✕</button>
    <img id="zoomImg" class="zoom-img" alt="Preview gambar diperbesar">
    <div class="zoom-toolbar">
      <button id="zoomOut">−</button>
      <button id="zoomReset">100%</button>
      <button id="zoomIn">+</button>
    </div>
  </div>

  <!-- Swiper JS -->
  <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

  <script>
  /* ========= CONFIG ========= */
  const API_URL = "https://script.google.com/macros/s/AKfycbw7z-KG3qwpi8-AkrMPGg2ONX_gWwepiN7oKPiAcx6n_fVBjASLZ79IMxsuV99tUisCwg/exec";
  const API_TOKEN = "1_sE-EY0hPXT_mQBg7sifRUoDAon6DvQNQZcUsrwnD0A";
  const LOCALE = "id-ID";
  const TZONE = 'Asia/Jakarta'; // zona yang dipakai untuk waktu jam-only
  /* ========================= */

  const $ = (s, ctx=document) => ctx.querySelector(s);
  const $$ = (s, ctx=document) => Array.from((ctx||document).querySelectorAll(s));
  const pad = n => String(n).padStart(2,'0');
  function showLoading(show=true){ $('#loadingOverlay')?.classList.toggle('show', !!show); }
  function formatRupiah(v){ if(v==null||v==='') return '-'; const n=Number(String(v).replace(/\D/g,'')); if(isNaN(n)) return v; return n.toLocaleString(LOCALE); }
  function safeParseJSON(t){ try{return JSON.parse(t);}catch(e){return null;} }
  async function safeFetch(url){ const res=await fetch(url,{cache:'no-cache'}); const txt=await res.text(); if(txt.trim().startsWith('<')) throw new Error('API returned HTML'); const j=safeParseJSON(txt); if(!j) throw new Error('Invalid JSON'); return j; }
  function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  /* ===== Time utilities (robust Jakarta handling) ===== */
  // gunakan Intl.formatToParts untuk mendapatkan waktu sekarang di timezone tertentu
  function getTZPartsNow(tz){
    const now = new Date();
    const fmt = new Intl.DateTimeFormat('en-US', {
      timeZone: tz,
      year: 'numeric', month: 'numeric', day: 'numeric',
      hour: 'numeric', minute: 'numeric', second: 'numeric',
      hour12: false
    });
    const partsArr = fmt.formatToParts(now);
    const parts = {};
    partsArr.forEach(p=> { if(p.type !== 'literal') parts[p.type] = p.value; });
    return {
      year: Number(parts.year),
      month: Number(parts.month),
      day: Number(parts.day),
      hour: Number(parts.hour),
      minute: Number(parts.minute),
      second: Number(parts.second)
    };
  }

  // get offset (minutes) such that:
  // absMsForTZWallClock = Date.UTC(year,month-1,day,h,m,s) - offsetMinutes*60000
  function getTZOffsetMinutes(tz){
    const now = new Date();
    const parts = getTZPartsNow(tz);
    const utcForParts = Date.UTC(parts.year, parts.month - 1, parts.day, parts.hour, parts.minute, parts.second);
    const diffMin = Math.round((utcForParts - now.getTime()) / 60000);
    return diffMin;
  }

  function normalizeHM(s){ return String(s||'').trim().replace(/[.]/g,':'); }
  function parseHM(str){
  if(!str) return null;
  const parts = String(str).trim().split(':').map(x=>parseInt(x,10));
  if(parts.length < 2) return null; 
  const h = parts[0];
  const m = parts[1] || 0;
  const s = parts[2] || 0;
  if(isNaN(h) || isNaN(m) || isNaN(s)) return null;
  return {h,m,s};
}

  function tryParseDateTime(str){
    if(!str) return null;
    // remove timezone tokens like WIB/WITA/WIT
    const s = String(str).replace(/(WIB|WITA|WIT|UTC[+-]?\d+|GMT[+-]?\d+)/ig,'').trim();
    // native Date parse
    const d = new Date(s);
    if(!isNaN(d.getTime())) return d;
    // dd/mm/yyyy hh:mm
    const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:[ T](\d{1,2})[:.](\d{2})(?::(\d{2}))?)?$/);
    if(m){
      let day=+m[1], mon=+m[2]-1, yr=+m[3]; if(yr<100) yr+=2000;
      let h=+(m[4]||0), mi=+(m[5]||0), se=+(m[6]||0);
      return new Date(yr, mon, day, h, mi, se, 0);
    }
    return null;
  }

  // Convert a TZ wall-clock (y,m,d,h,m,s) into absolute epoch ms
  function tzWallClockToEpochMs(tz, year, month, day, hour, minute, second){
    const offsetMin = getTZOffsetMinutes(tz);
    // Date.UTC treats given components as UTC; subtracting offset gets the actual instant for that wall-clock in tz
    return Date.UTC(year, month - 1, day, hour, minute, second || 0) - (offsetMin * 60000);
  }

  // Returns promo status given start/end strings.
  // Supports:
  //  - absolute datetimes (dd/mm/yyyy HH:MM or JS-parseable)
  //  - time-only HH:MM (interpreted as day-time in Asia/Jakarta)
  // If end is omitted, uses 23:59:59; if start omitted uses 00:00:00.
  function getPromoStatus(startStr, endStr){
  const clean = v => (v||'').toString().replace(/[–—]/g,'-').trim();
  const sStr = clean(startStr), eStr = clean(endStr);
  if(!sStr && !eStr) return {active:false, secondsLeft:0};

  const sDT = tryParseDateTime(sStr);
  const eDT = tryParseDateTime(eStr);
  const containsDate = (t) => /\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(String(t));

  // --- Absolute datetime (punya tanggal) ---
  if((sDT || eDT) && (containsDate(sStr) || containsDate(eStr))){
    const partsNow = getTZPartsNow(TZONE);
    const nowMs = tzWallClockToEpochMs(TZONE, partsNow.year, partsNow.month, partsNow.day, partsNow.hour, partsNow.minute, partsNow.second);

    let startMs = sDT ? sDT.getTime() : nowMs;
    let endMs   = eDT ? eDT.getTime() : (sDT ? sDT.getTime()+24*3600*1000 : nowMs);
    const active = nowMs >= startMs && nowMs <= endMs;
    const secondsLeft = active ? Math.max(0, Math.floor((endMs - nowMs)/1000)) : 0;
    return {active, secondsLeft};
  }

  // --- Jam-only (HH:MM) ---
  const st = parseHM(sStr || '00:00');
  const en = parseHM(eStr || '23:59:59');
  if(!st || !en) return {active:false, secondsLeft:0};

  const baseParts = getTZPartsNow(TZONE);
  const startMs = tzWallClockToEpochMs(TZONE, baseParts.year, baseParts.month, baseParts.day, st.h, st.m, st.s||0);
  let endMs = tzWallClockToEpochMs(TZONE, baseParts.year, baseParts.month, baseParts.day, en.h, en.m, en.s||0);

  // --- jika end <= start → dianggap lewat tengah malam ---
  if(endMs <= startMs) endMs += 24*3600*1000;

  const nowMs = Date.now();
  const active = nowMs >= startMs && nowMs <= endMs;
  const secondsLeft = active ? Math.max(0, Math.floor((endMs - nowMs)/1000)) : 0;
  return {active, secondsLeft};
}

  function formatHMS(total){
    const s = Math.max(0, Math.floor(total));
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}j ${pad(m)}m ${pad(sec)}dtk`;
  }

  /* ====== App state & helpers (unchanged) ====== */
  let SETTINGS = {};
  let PRODUCTS = [], SLIDES = [], GALLERY = [], TESTIS = [];
  let cart = [];
  let heroSwiper, gallerySwiper, testiSwiper;

  async function fetchSheet(name){
    const url = `${API_URL}?sheet=${encodeURIComponent(name)}&token=${encodeURIComponent(API_TOKEN)}`;
    const j = await safeFetch(url);
    if(j.status === 'success') return j.data || [];
    if(Array.isArray(j)) return j;
    return [];
  }
  function rowsToMap(rows){
    const m={};
    (rows||[]).forEach(r=>{
      if(r.key != null && r.value != null){
        m[String(r.key).trim().toLowerCase()] = r.value;
      } else {
        const ks = Object.keys(r||{});
        if(ks.length>=2 && r[ks[0]] != null){
          m[String(r[ks[0]]).trim().toLowerCase()] = r[ks[1]];
        }
      }
    });
    return m;
  }
  const getAny = (r, keys=[]) => { for(const k of keys){ if(r[k]!==undefined && r[k]!=='' && r[k]!==null) return r[k]; } return ''; };

  function normalizeSlides(rows){
    return (rows||[]).map(r=>({
      bg: getAny(r,['bg','bg_image','bg image','bg_image_url','background']),
      img: getAny(r,['image','image_url','gambar','gbr','gbr image']),
      alt: getAny(r,['altslider','alt slider','alt_slider','alt','alt_text']),
      title: getAny(r,['judulslider','judul slider','title','judul']),
      // prioritas ket_slider seperti request
      caption: getAny(r,['ket_slider','ketslider','ket slider','caption','keterangan','ket','keterangan slider','deskripsi','description','desc']),
      btn_text: getAny(r,['tombol','button','btn_text']) || 'Lihat',
      btn_link: getAny(r,['tombol_link','button_link','btn_link','link']) || '#'
    }));
  }

  function normalizeProducts(rows){
  return (rows||[]).map((r,i)=>{
    const tglStart = getAny(r,['tglpromostart','tgl_start','tanggalmulai']) || '';
    const tglEnd   = getAny(r,['tglpromoend','tgl_end','tanggalselesai']) || '';
    const jamStart = getAny(r,['jampromostart','jam_start','jammulai']) || '';
    const jamEnd   = getAny(r,['jampromoend','jam_end','jamselesai']) || '';

    let promostart='', promoend='';

    if(tglStart && !tglEnd) {
      promostart = `${tglStart} ${jamStart||'00:00'}`;
      promoend   = `${tglStart} ${jamEnd||'23:59'}`;
    } else if(!tglStart && !tglEnd) {
      promostart = jamStart || '';
      promoend   = jamEnd || '';
    } else {
      promostart = `${tglStart||''} ${jamStart||'00:00'}`.trim();
      promoend   = `${tglEnd||tglStart||''} ${jamEnd||'23:59'}`.trim();
    }

    const rawStatus = String(getAny(r,['aktif','status','is_active'])).trim().toLowerCase();
    // treat explicit 'no','n','false','0' as inactive, otherwise active (default yes)
    const aktif = !(rawStatus === 'no' || rawStatus === 'n' || rawStatus === 'false' || rawStatus === '0');

    return {
      id: getAny(r,['id','ID','Id']) || 'p'+i,
      nama: getAny(r,['namaproduk','nama produk','nama_produk','judul produk','judulproduk','produk','nama','name','productname','product_name']) || 'Produk',
      gbr: getAny(r,['gbrproduk','gambar produk','gambar_produk','gbr','gambar','image','gbr image']),
      alt: getAny(r,['altproduk','alt_produk','alt produk','alt','alt_text','alt_gambar','alt image']),
      hargaawal: getAny(r,['hargaawal','harga awal','harga','price']),
      hargadiskon: getAny(r,['hargadiskon','harga diskon','hargadisc','diskon']),
      promostart,
      promoend,
      desc: getAny(r,['deskripsi','description','desc','keterangan','keterangan produk']) || '',
      aktif: aktif
    };
  });
}

  function normalizeGallery(rows){
    return (rows||[]).map(r=>({
      url: getAny(r,['gambar_url','image','url','gambar','link']),
      alt: getAny(r,['altgaleri','alt_gallery','alt','alt_text'])
    }));
  }

  function normalizeTestis(rows){
    return (rows||[]).map(r=>({
      nama:getAny(r,['nama','name']),
      jabatan:getAny(r,['jabatan','role']),
      gambar:getAny(r,['gambar_url','gambar','image']), // prefer gambar_url
      alt:getAny(r,['alt','alt_text','alt_gambar']) || getAny(r,['nama','name'])
    }));
  }

  function applySettings(s){
    if(!s) return;
    SETTINGS = s;
    if(s['site title']||s.site_title) { const title = s['site title']||s.site_title; document.title = title; $('#brand-name').textContent = title; }
    if(s.logo) $('#site-logo').src = s.logo;
    if(s.icon) $('#favicon').href = s.icon;
    if(s.warna) document.documentElement.style.setProperty('--accent', s.warna);
    if(s.textpromo) $('#promo-text').textContent = s.textpromo;

    if(s.wa){
      const waLink = `https://wa.me/${s.wa}?text=${encodeURIComponent(s['wa message']||s.wa_message||'')}`;
      $('#waFloat').href = waLink;
      $('#footer-wa').href = waLink;
      $('#footer-wa').textContent = s.wa;
    }
    if(s.alamat) $('#footer-address').textContent = s.alamat;
    if(s['jam buka']) $('#footer-hours').textContent = s['jam buka'];
    if(s.deskripsi) $('#footer-desc').textContent = s.deskripsi;

    if(s.maps){
      const holder = $('#footer-map'); holder.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.loading = 'lazy'; iframe.src = s.maps; iframe.title = 'Peta Lokasi';
      holder.appendChild(iframe);
      let t = setTimeout(()=> { holder.innerHTML = `<a href="${s.maps}" target="_blank" rel="noopener" style="color:var(--accent)">Buka Peta (klik)</a>` }, 7000);
      iframe.addEventListener('load', ()=> clearTimeout(t), {once:true});
    }

    if(s.video_embed) $('#videoWrapper').innerHTML = `<iframe src="${s.video_embed}" frameborder="0" allowfullscreen loading="lazy" title="Video Produksi"></iframe>`;
  }

  /* ===== renderers, swipers, cart, UI, reveal observer, zoom ... (sama seperti versi terakhir) ===== */
  /* Untuk ringkas: salin semua fungsi renderHero, renderProducts, renderGallery, renderTesti,
     initSwipers, updateCountdowns (yang memanggil getPromoStatus), cart functions, setupUI,
     reveal observer, zoom, dan init loop dari file sebelumnya — mereka tetap sama. */

  // Karena pesan ini fokus pada perbaikan countdown, saya menyertakan fungsi updateCountdowns yang memakai getPromoStatus:
  function renderHero(){
    const container = $('#slidesContainer');
    container.innerHTML = '';
    if(!SLIDES.length) SLIDES = [{bg:'https://images.unsplash.com/photo-1523986371872-9d3ba2e2f642?auto=format&fit=crop&w=1600&q=60', img:'https://img.icons8.com/emoji/96/egg-emoji.png', title:'Sabiq Bejo', caption:'Telur Asin Lamongan', btn_text:'Pesan', btn_link:'#products', alt:'Telur asin'}];
    SLIDES.forEach(s=>{
      const slide = document.createElement('div'); slide.className='swiper-slide';
      if(s.bg) slide.style.backgroundImage = `url('${s.bg}')`;
      slide.innerHTML = `<div class="slide-content">
        ${s.img ? `<img src="${s.img}" alt="${escapeHtml(s.alt||s.title||'Slide')}" loading="lazy" decoding="async" data-zoom="1">` : ''}
        <div class="slide-text">
          <h2>${escapeHtml(s.title||'')}</h2>
          ${s.caption ? `<p>${escapeHtml(s.caption)}</p>` : ''}
          <a class="cta" href="${s.btn_link||'#'}">${escapeHtml(s.btn_text||'Lihat')}</a>
        </div>
      </div>`;
      container.appendChild(slide);
    });
  }

  function renderProducts(){
  const grid = $('#productsGrid'); grid.innerHTML = '';
  if(!PRODUCTS.length){ grid.innerHTML = '<p>Tidak ada produk</p>'; return; }
  PRODUCTS.forEach(p=>{
    if(!p.aktif) return; // safety (seharusnya sudah terfilter)
    const card = document.createElement('div'); card.className='card'; 
    card.dataset.id = p.id || '';
    card.dataset.start = p.promostart || '';
    card.dataset.end = p.promoend || '';
    card.dataset.hargaawal = p.hargaawal || '';
    card.dataset.hargadiskon = p.hargadiskon || '';

    const promoLabel = document.createElement('div'); promoLabel.className='promo-label'; promoLabel.textContent='PROMO'; card.appendChild(promoLabel);

    const iw = document.createElement('div'); iw.className='img-wrapper';
    const img = document.createElement('img');
    img.src = p.gbr || 'https://via.placeholder.com/400x400?text=No+Image';
    img.alt = p.alt || p.nama || 'Produk';
    img.loading='lazy'; img.decoding='async'; img.setAttribute('data-zoom','1');
    iw.appendChild(img);

    const co = document.createElement('div'); co.className='countdown-overlay'; co.style.display='none'; co.setAttribute('aria-live','polite'); iw.appendChild(co);
    card.appendChild(iw);

    const title = document.createElement('h3'); title.textContent = p.nama; card.appendChild(title);

    // Deskripsi (tampil singkat di index / preview)
    if(p.desc){
      const descEl = document.createElement('p');
      descEl.className = 'product-desc';
      // batasi panjang preview (misal 110 karakter)
      const preview = String(p.desc).trim();
      descEl.textContent = preview.length > 110 ? preview.slice(0,110)+'…' : preview;
      card.appendChild(descEl);

      // optional: data attribute full desc for modal/zoom detail
      card.dataset.fulldesc = String(p.desc);
    }

    const priceWrap = document.createElement('div'); priceWrap.className='price';
    const old = document.createElement('span'); old.className='old'; old.textContent = 'Rp ' + formatRupiah(p.hargaawal);
    const neu = document.createElement('span'); neu.className='new'; neu.textContent = 'Rp ' + formatRupiah(p.hargadiskon || p.hargaawal);
    priceWrap.appendChild(old); priceWrap.appendChild(neu);
    card.appendChild(priceWrap);

    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Tambah ke Keranjang';
    btn.addEventListener('click', ()=> addToCartFromCard(card));
    card.appendChild(btn);

    grid.appendChild(card);
  });
}


  function renderGallery(){
    const g = $('#galleryGrid'); g.innerHTML = '';
    if(!GALLERY.length) GALLERY = [{url:'https://via.placeholder.com/1000x700?text=Gallery', alt:'Galeri'}];
    GALLERY.forEach(it=>{
      const slide = document.createElement('div'); slide.className='swiper-slide gallery-item';
      slide.innerHTML = `<img src="${it.url||''}" alt="${escapeHtml(it.alt||'Galeri')}" loading="lazy" decoding="async" data-zoom="1">`;
      g.appendChild(slide);
    });
  }

  function renderTesti(){
    const t = $('#testiGrid'); t.innerHTML = '';
    if(!TESTIS.length) TESTIS = [{nama:'Budi', jabatan:'Pelanggan', gambar:'https://via.placeholder.com/600x400?text=User', alt:'Testimoni'}];
    TESTIS.forEach(it=>{
      const slide = document.createElement('div'); slide.className='swiper-slide';
      slide.innerHTML = `<div class="testimonial-card">
        <img src="${it.gambar||''}" alt="${escapeHtml(it.alt||it.nama||'Pelanggan')}" loading="lazy" decoding="async" data-zoom="1">
        <p><strong>${escapeHtml(it.nama||'')}</strong><br><small>${escapeHtml(it.jabatan||'')}</small></p>
      </div>`;
      t.appendChild(slide);
    });
  }

  function initSwipers(){
    if(heroSwiper) heroSwiper.destroy(true,true);
    heroSwiper = new Swiper('#swiperHero', {
      loop:true, autoplay:{delay:5000,disableOnInteraction:false},
      pagination:{el:'#swiperHero .swiper-pagination',clickable:true},
      navigation:{nextEl:'#swiperHero .swiper-button-next',prevEl:'#swiperHero .swiper-button-prev'},
      effect:'slide', grabCursor:true, keyboard:{enabled:true}
    });

    if(gallerySwiper) gallerySwiper.destroy(true,true);
    gallerySwiper = new Swiper('#gallerySwiper', {
      loop:true,
      slidesPerView:1.2,
      spaceBetween:12,
      breakpoints:{
        480:{slidesPerView:2},
        640:{slidesPerView:3},
        900:{slidesPerView:4},
        1200:{slidesPerView:5}
      },
      pagination:{el:'#gallerySwiper .swiper-pagination',clickable:true},
      navigation:{nextEl:'#gallerySwiper .swiper-button-next',prevEl:'#gallerySwiper .swiper-button-prev'},
      grabCursor:true
    });

    if(testiSwiper) testiSwiper.destroy(true,true);
    testiSwiper = new Swiper('#testiSwiper', {
      slidesPerView:1.1,spaceBetween:12,loop:true,
      breakpoints:{640:{slidesPerView:2},900:{slidesPerView:3}},
      pagination:{el:'#testiSwiper .swiper-pagination',clickable:true},
      grabCursor:true
    });
  }

  function updateCountdowns(){
    const cards = $$('#productsGrid .card');
    let anyPromo=false;

    cards.forEach(card=>{
      const co = $('.countdown-overlay', card);
      const promoLabel = $('.promo-label', card);
      const oldEl = $('.old', card);
      const newEl = $('.new', card);

      const start = (card.dataset.start||'').trim();
      const end = (card.dataset.end||'').trim();
      const hargaAwal = card.dataset.hargaawal || '';
      const hargaDiskon = card.dataset.hargadiskon || '';

      const {active, secondsLeft} = getPromoStatus(start, end);

      if(active && secondsLeft>0){
        anyPromo=true;
        if(co) { co.textContent = formatHMS(secondsLeft); co.style.display='block'; }
        if(promoLabel) promoLabel.style.display='inline-block';
        if(oldEl) oldEl.style.display = (hargaDiskon ? 'inline-block' : 'none');
        if(newEl) newEl.textContent = 'Rp ' + formatRupiah(hargaDiskon||hargaAwal);
      } else {
        if(co) co.style.display='none';
        if(promoLabel) promoLabel.style.display='none';
        if(oldEl) oldEl.style.display='none';
        if(newEl) newEl.textContent = 'Rp ' + formatRupiah(hargaAwal);
      }
    });

    const promoBar = $('#promo-bar');
    promoBar.style.display = anyPromo ? 'block' : 'none';
    document.documentElement.style.setProperty('--headerTop', anyPromo ? '36px' : '0px');
  }

  /* ---- cart, UI, reveal, zoom functions (reuse from previous file) ---- */
  function addToCartFromCard(card){
    const id = card.dataset.id || ('tmp-'+Math.random().toString(36).slice(2,8));
    const name = card.querySelector('h3')?.innerText || 'Produk';
    const priceText = card.querySelector('.price .new')?.innerText || '';
    const priceNum = Number(String(priceText).replace(/\D/g,'')) || Number(String(card.dataset.hargadiskon || card.dataset.hargaawal || 0).replace(/\D/g,'')) || 0;
    const existing = cart.find(i=>i.id===id);
    if(existing) existing.qty++;
    else cart.push({id, name, price:priceNum, qty:1});
    updateCartUI();
  }
  function updateCartUI(){
    const count = cart.reduce((s,i)=>s+(i.qty||0),0);
    const badge = $('#cartBadge');
    if(count>0){ badge.style.display='inline-block'; badge.textContent = count; } else { badge.style.display='none'; }
    renderCartPanel();
  }
  function renderCartPanel(){
    const list = $('#cartItemsList'); list.innerHTML='';
    if(cart.length===0){ list.innerHTML='<p>Keranjang kosong</p>'; $('#cartTotal').textContent = 'Rp 0'; return; }
    let total=0;
    cart.forEach(it=>{
      total += it.price * it.qty;
      const row = document.createElement('div'); row.className='cart-item';
      row.innerHTML = `
        <div style="max-width:60%">
          <div style="font-weight:800">${escapeHtml(it.name)}</div>
          <div style="font-size:.9rem;color:var(--muted)">Rp ${formatRupiah(it.price)} / pcs</div>
        </div>
        <div class="qty-controls" data-id="${it.id}">
          <button class="qty-btn" data-change="-1" aria-label="Kurangi">−</button>
          <input type="number" value="${it.qty}" class="qty-input" style="width:45px;text-align:center;font-weight:800">
          <button class="qty-btn" data-change="1" aria-label="Tambah">+</button>
        </div>
      `;
      list.appendChild(row);
    });
    $('#cartTotal').textContent = 'Rp ' + formatRupiah(total);
    list.querySelectorAll('.qty-controls button').forEach(btn=>{
      btn.removeEventListener('click', onQtyBtnClick);
      btn.addEventListener('click', onQtyBtnClick);
    });
    list.querySelectorAll('.qty-input').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const id = inp.closest('.qty-controls').dataset.id;
      const item = cart.find(i=>i.id===id);
      if(item){
        const v = parseInt(inp.value,10);
        item.qty = isNaN(v) || v<=0 ? 1 : v;
        updateCartUI();
        }
      });
    });

  }
  function onQtyBtnClick(e){
    const btn = e.currentTarget;
    const change = Number(btn.dataset.change||0);
    const parent = btn.closest('.qty-controls'); if(!parent) return;
    const id = parent.dataset.id;
    const item = cart.find(i=>i.id===id); if(!item) return;
    item.qty += change;
    if(item.qty <= 0) cart = cart.filter(i=>i.id!==id);
    updateCartUI();
  }

  function setupUI(){
    const darkOn = localStorage.getItem('dark')==='1';
    if(darkOn) document.body.classList.add('dark');
    syncCloseCartDark();

    $('#menuToggle').addEventListener('click', ()=> { $('#offcanvasLeft').classList.add('active'); $('#offcanvasLeft').setAttribute('aria-hidden','false'); });
    $('#offLeftClose').addEventListener('click', ()=> { $('#offcanvasLeft').classList.remove('active'); $('#offcanvasLeft').setAttribute('aria-hidden','true'); });
    $$('.off-link').forEach(a=> a.addEventListener('click', ()=> $('#offcanvasLeft').classList.remove('active')));

    $('#cartFloat').addEventListener('click', ()=> { $('#cartPanel').classList.add('active'); $('#cartPanel').setAttribute('aria-hidden','false'); renderCartPanel(); });
    $('#closeCartPanel').addEventListener('click', ()=> { $('#cartPanel').classList.remove('active'); $('#cartPanel').setAttribute('aria-hidden','true'); });
    $('#clearCart').addEventListener('click', ()=> { cart=[]; updateCartUI(); });

    $('#checkoutBtn').addEventListener('click', ()=>{
      if(!SETTINGS.wa){ alert('Nomor WhatsApp belum diatur di sheet Pengaturan.'); return; }
      if(cart.length===0){ alert('Keranjang masih kosong'); return; }
      let msg = 'Saya ingin memesan:%0A';
      cart.forEach(i=> msg += `- ${i.name} x${i.qty} (Rp ${formatRupiah(i.price*i.qty)})%0A`);
      window.open(`https://wa.me/${SETTINGS.wa}?text=${msg}`, '_blank');
    });

    $('#darkToggle').addEventListener('click', ()=>{
      const on = document.body.classList.toggle('dark');
      localStorage.setItem('dark', on ? '1' : '0');
      syncCloseCartDark();
    });

    const topBtn = $('#scrollTopBtn');
    const checkTopBtn = ()=>{
      if(window.scrollY > 200) topBtn.classList.add('visible');
      else topBtn.classList.remove('visible');
    };
    window.addEventListener('scroll', checkTopBtn, {passive:true});
    checkTopBtn();
    topBtn.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));

    document.body.addEventListener('click', (e)=>{
      const img = e.target.closest('img[data-zoom]');
      if(!img) return;
    
      const card = img.closest('.card');
      if(card && card.dataset.fulldesc){
        // kalau gambar produk → buka modal produk (full desc)
        openProductModal(card);
      } else {
        // kalau gambar galeri/testimoni → tetap zoom
        openZoom(img.src, img.alt||'Gambar');
      }
    });

    $('#zoomClose').addEventListener('click', closeZoom);
    $('#zoomIn').addEventListener('click', ()=> setZoom(scale*1.2));
    $('#zoomOut').addEventListener('click', ()=> setZoom(scale/1.2));
    $('#zoomReset').addEventListener('click', ()=> { setZoom(1); setTranslate(0,0); });
    $('#zoomOverlay').addEventListener('wheel',(e)=>{ e.preventDefault(); const d = e.deltaY>0 ? 0.9 : 1.1; setZoom(scale*d); }, {passive:false});

    const zi = $('#zoomImg');
    zi.addEventListener('pointerdown', e=>{ e.preventDefault(); zi.setPointerCapture(e.pointerId); dragging=true; startX=e.clientX; startY=e.clientY; baseX=tx; baseY=ty; });
    zi.addEventListener('pointermove', e=>{ if(!dragging) return; setTranslate(baseX + (e.clientX-startX), baseY + (e.clientY-startY)); });
    zi.addEventListener('pointerup', ()=> dragging=false);
    zi.addEventListener('pointercancel', ()=> dragging=false);

    setupRevealObserver();
  }

  function syncCloseCartDark(){
    const on = document.body.classList.contains('dark');
    document.querySelectorAll('.close-cart').forEach(b=> b.classList.toggle('dark', on));
  }

  let revealObserver;
  function setupRevealObserver(){
    const opts = {root:null, rootMargin:'0px 0px -10% 0px', threshold:0.08};
    revealObserver = new IntersectionObserver((entries, obs)=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          const el = entry.target;
          if(el.tagName === 'IMG'){ el.classList.add('show'); }
          else { el.querySelectorAll && el.querySelectorAll('img').forEach(img=> img.classList.add('show')); }
          entry.target.classList.add && entry.target.classList.add('show');
          obs.unobserve(entry.target);
        }
      });
    }, opts);
    // observe placeholders later (called after render)
  }

  let scale=1, tx=0, ty=0, dragging=false, startX=0, startY=0, baseX=0, baseY=0;
  function openZoom(src, alt=''){
    const ov = $('#zoomOverlay'), img = $('#zoomImg');
    img.src = src; img.alt = alt;
    setZoom(1); setTranslate(0,0);
    ov.classList.add('show'); ov.style.display='flex'; ov.setAttribute('aria-hidden','false');
  }
  function closeZoom(){ const ov=$('#zoomOverlay'); ov.classList.remove('show'); ov.style.display='none'; ov.setAttribute('aria-hidden','true'); }
  function setZoom(v){ scale = Math.max(1, Math.min(6, v)); $('#zoomImg').style.setProperty('--scale', scale); }
  function setTranslate(x,y){ tx = x; ty = y; $('#zoomImg').style.setProperty('--tx', tx+'px'); $('#zoomImg').style.setProperty('--ty', y+'px'); }

  async function loadArticles(){
  const rows = await fetchSheet('Artikel').catch(()=>[]);
  const container = document.getElementById('blogList');
  container.innerHTML = '';
  if(!rows.length){ container.innerHTML = '<p>Belum ada artikel</p>'; return; }

  rows.sort(() => Math.random() - 0.5); // acak
  rows.slice(0,6).forEach(r=>{
    const judul = r.judul || 'Artikel';
    const slug = r.slug || '#';
    const desc = r.deskripsi || (r.isi ? r.isi.substring(0,80)+'…' : '');
    const img = r.gambar || 'https://via.placeholder.com/400x400?text=Artikel';

    const card = document.createElement('div');
    card.className = 'blog-card';
    card.innerHTML = `
      <img src="${img}" alt="${judul}">
      <h3>${judul}</h3>
      <p>${desc}</p>
      <a href="/artikel.html?slug=${slug}" target="_blank">Baca Selengkapnya</a>
    `;
    container.appendChild(card);
  });

    // ambil 3 artikel pertama sebagai "populer"
    const popular = rows.slice(0,3);
    const popCont = document.getElementById('popularArticles');
    popCont.innerHTML = '<h4 style="margin:8px 0;color:var(--accent)">Artikel Populer</h4>';
    popular.forEach(r=>{
      const judul = r.judul || 'Artikel';
      const slug = r.slug || '';
      popCont.innerHTML += `<p><a href="#" onclick="openArticleModal('${escapeHtml(judul)}','${escapeHtml(r.isi||'')}');return false;" style="color:var(--accent);text-decoration:underline">${judul}</a></p>`;
    });

}
    
/* ====== INIT ====== */
  (async function init(){
    showLoading(true);
    if(localStorage.getItem('dark')==='1') document.body.classList.add('dark');

    try{
      const settingsRows = await fetchSheet('Pengaturan').catch(()=>[]);
      SETTINGS = rowsToMap(settingsRows);
      applySettings(SETTINGS);

      const [slidesRows, productsRows, galleryRows, testiRows] = await Promise.all([
        fetchSheet('Slider').catch(()=>[]),
        fetchSheet('Produk').catch(()=>[]),
        fetchSheet('Galeri').catch(()=>[]),
        fetchSheet('Testimoni').catch(()=>[])
      ]);

      SLIDES = normalizeSlides(slidesRows);
      PRODUCTS = normalizeProducts(productsRows);
      // Hilangkan produk yang tidak aktif (status = no)
      PRODUCTS = PRODUCTS.filter(p => !!p.aktif);
      GALLERY = normalizeGallery(galleryRows);
      TESTIS = normalizeTestis(testiRows);

      renderHero();
      renderProducts();
      renderGallery();
      renderTesti();
      await loadArticles();
      await loadPopularArticles();
      initSwipers();
      setupUI();

      // attach reveal observation to new elements
      setTimeout(()=> {
        $$('#productsGrid .card').forEach(el=> revealObserver.observe(el));
        $$('#galleryGrid img').forEach(img=> revealObserver.observe(img));
        $$('#testiGrid img').forEach(img=> revealObserver.observe(img));
        $$('#slidesContainer img').forEach(img=> revealObserver.observe(img));
      }, 50);

      // Countdown loop (fixed)
      updateCountdowns();
      setInterval(updateCountdowns, 1000);

    } catch(err){
      console.error('Init error', err);
      alert('Gagal muat data. Periksa API_URL/API_TOKEN & Apps Script deployment.');
    } finally {
      showLoading(false);
    }
  })();

    // -- Isi standar (bahasa Indonesia) --
    const LEGAL_TEXT = {
      tos: {
        title: 'Syarat & Ketentuan',
        content: `
          <p><strong>Selamat datang di Sabiq Bejo.</strong></p>
          <p>Dengan mengakses dan menggunakan situs ini, Anda menyetujui syarat dan ketentuan berikut. Mohon baca dengan teliti:</p>
          <ol>
            <li><strong>Penggunaan Layanan.</strong> Anda setuju menggunakan layanan ini sesuai hukum yang berlaku dan tidak menyalahgunakan konten.</li>
            <li><strong>Pemesanan & Pembayaran.</strong> Pesanan diproses berdasarkan ketersediaan stok. Pembayaran dilakukan sesuai metode yang tersedia (WhatsApp ordering pada implementasi ini).</li>
            <li><strong>Harga & Promo.</strong> Harga dapat berubah sewaktu-waktu. Promo memiliki syarat dan periode berlaku yang ditentukan di sheet.</li>
            <li><strong>Tanggung Jawab.</strong> Kami tidak bertanggung jawab atas kesalahan input alamat oleh pengguna atau keterlambatan kurir di luar kendali kami.</li>
            <li><strong>Perubahan.</strong> Kami berhak mengubah syarat ini kapan saja. Perubahan akan berlaku setelah dipublikasikan di situs.</li>
          </ol>
          <p>Jika ada pertanyaan, hubungi kontak pada footer.</p>
        `
      },
      privacy: {
        title: 'Kebijakan Privasi',
        content: `
          <p>Kami menjaga privasi pengunjung. Intinya:</p>
          <ol>
            <li><strong>Data yang Dikumpulkan.</strong> Kami dapat mengumpulkan data kontak (nomor WA), data pemesanan, dan data teknis (cookie untuk fungsionalitas dasar).</li>
            <li><strong>Tujuan Pemakaian.</strong> Data digunakan untuk memproses pesanan, komunikasi, dan peningkatan layanan.</li>
            <li><strong>Penyimpanan & Keamanan.</strong> Kami menyimpan data dengan langkah-langkah dasar pengamanan; namun tidak menjamin keamanan mutlak dari pihak ketiga.</li>
            <li><strong>Pembagian Data.</strong> Data tidak akan dibagikan ke pihak ketiga kecuali untuk keperluan pengiriman atau permintaan hukum.</li>
          </ol>
          <p>Dengan menggunakan situs ini, Anda menyetujui pengumpulan dan penggunaan sesuai kebijakan ini.</p>
        `
      },
      refund: {
        title: 'Kebijakan Pengembalian & Refund',
        content: `
          <p>Kebijakan pengembalian singkat:</p>
          <ol>
            <li>Produk yang sudah dikirim tidak dapat dikembalikan kecuali terdapat kerusakan atau kesalahan produk dari pihak kami.</li>
            <li>Jika ada kerusakan, silakan kirim bukti foto ke kontak WA pada footer dalam waktu 48 jam setelah barang diterima.</li>
            <li>Pengembalian dana (refund) akan diproses setelah verifikasi, dan dapat memakan waktu beberapa hari kerja.</li>
          </ol>
          <p>Untuk bantuan, hubungi kontak kami.</p>
        `
      }
    };
    </script>
    <!-- LEGAL MODAL -->
    <div id="legalOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:30000;align-items:center;justify-content:center;">
      <div id="legalModal" style="width:calc(100% - 40px);max-width:900px;background:var(--card);color:var(--text);border-radius:10px;padding:18px;box-shadow:0 8px 40px rgba(0,0,0,.4);max-height:80vh;overflow:auto;position:relative;">
        <button id="legalClose" style="position:absolute;top:10px;right:10px;background:var(--accent);border:0;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:800">Tutup</button>
        <h2 id="legalTitle" style="margin-top:4px">Judul</h2>
        <div id="legalContent" style="line-height:1.6;margin-top:10px;color:var(--muted)"></div>
      </div>
    </div>
    <script>
    document.addEventListener("DOMContentLoaded", function(){
      // fungsi openLegal tetap sama
      function openLegal(type){
        const overlay = document.getElementById('legalOverlay');
        const title = document.getElementById('legalTitle');
        const content = document.getElementById('legalContent');
        const data = LEGAL_TEXT[type] || {title:'', content:''};
        title.innerHTML = data.title;
        content.innerHTML = data.content;
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden','false');
        document.getElementById('legalModal').scrollTop = 0;
      }
    
      document.getElementById('legalClose').addEventListener('click', ()=>{
        document.getElementById('legalOverlay').style.display = 'none';
        document.getElementById('legalOverlay').setAttribute('aria-hidden','true');
      });
    
      document.getElementById('legalOverlay').addEventListener('click', (e)=>{
        if(e.target === document.getElementById('legalOverlay')){
          document.getElementById('legalOverlay').style.display = 'none';
          document.getElementById('legalOverlay').setAttribute('aria-hidden','true');
        }
      });
    
      document.getElementById('tosLink').addEventListener('click', (e)=>{ e.preventDefault(); openLegal('tos'); });
      document.getElementById('privacyLink').addEventListener('click', (e)=>{ e.preventDefault(); openLegal('privacy'); });
      document.getElementById('refundLink').addEventListener('click', (e)=>{ e.preventDefault(); openLegal('refund'); });
    });
    </script>
    <!-- PRODUCT DETAIL MODAL -->
    <div id="productOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:25000;align-items:center;justify-content:center;">
      <div id="productModal" style="width:calc(100% - 40px);max-width:700px;background:var(--card);color:var(--text);border-radius:10px;padding:18px;box-shadow:0 8px 40px rgba(0,0,0,.4);max-height:80vh;overflow:auto;position:relative;">
        <button id="productClose" style="position:absolute;top:10px;right:10px;background:var(--accent);border:0;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:800">✖</button>
        <h2 id="productTitle" style="margin-top:4px"></h2>
        <img id="productImage" src="" alt="" style="width:100%;border-radius:8px;margin:10px 0">
        <div id="productDesc" style="line-height:1.6;margin-top:10px;color:var(--muted)"></div>
      </div>
    </div>
    <script>
    // === PRODUCT MODAL SCRIPT ===
    function openProductModal(card){
      const overlay = document.getElementById('productOverlay');
      document.getElementById('productTitle').textContent = card.querySelector('h3')?.textContent || 'Produk';
      document.getElementById('productImage').src = card.querySelector('img')?.src || '';
      document.getElementById('productDesc').textContent = card.dataset.fulldesc || '';
      overlay.style.display = 'flex';
    }
    
    document.getElementById('productClose').addEventListener('click', ()=>{
      document.getElementById('productOverlay').style.display = 'none';
    });
    
    document.getElementById('productOverlay').addEventListener('click', (e)=>{
      if(e.target === document.getElementById('productOverlay')){
        document.getElementById('productOverlay').style.display = 'none';
      }
    });
    
    // Ganti event klik gambar produk → buka modal produk
    document.body.addEventListener('click', (e)=>{
      const img = e.target.closest('img[data-zoom]');
      if(!img) return;
      const card = img.closest('.card');
      if(card && card.dataset.fulldesc){
        e.preventDefault();
        openProductModal(card);
      }
    });
    </script>

</body>
</html>
