<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="site-title">Loading...</title>
  <link id="favicon" rel="icon" href="">
  <style>
:root {
      --primary: #000;
      --accent: #ffd700;
      --bg: #fff;
      --text: #333;
      --cart-bg: #fff;
      --cart-text: #000;
      --max-width: 1200px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Promo marquee */
    .promo-marquee {
      background: var(--accent);
      color: #000;
      font-weight: 700;
      padding: 0.45rem 1rem;
      text-align: center;
      font-size: 0.95rem;
      position: sticky;
      top: 0;
      z-index: 1100;
    }
    .promo-marquee a { color: inherit; text-decoration: none; }

    /* Header / Navbar */
    header { background: var(--primary); color: var(--accent); position: sticky; top: 0; z-index: 1000; }
    .header-bar { max-width: var(--max-width); margin: 0 auto; display:flex; align-items:center; justify-content:space-between; padding:12px; gap:12px; }
    .logo { display:flex; gap:10px; align-items:center; font-weight:700; font-size:1.15rem; color:var(--accent); }
    .logo img { width:36px; height:36px; border-radius:6px; display:block; }
    nav .nav-desktop ul { list-style:none; margin:0; padding:0; display:flex; gap:14px; align-items:center; }
    nav a { color:var(--accent); text-decoration:none; font-weight:700; }
    .menu-toggle { display:none; background:none; color:var(--accent); border:none; font-size:1.6rem; }

    /* Hero slider */
    #hero { position:relative; height:74vh; max-height:760px; overflow:hidden; background:#111; }
    .slide { position:absolute; inset:0; background-size:cover; background-position:center; opacity:0; transition:opacity .6s ease; display:flex; align-items:center; justify-content:center; }
    .slide.active { opacity:1; }
    .slide::before { content:""; position:absolute; inset:0; background:rgba(0,0,0,0.45); }
    .slide-content { position:relative; z-index:2; display:flex; gap:2rem; align-items:center; max-width:1000px; width:100%; padding:28px; color:var(--accent); }
    .slide-content img { width:240px; aspect-ratio:1/1; object-fit:contain; border-radius:10px; background:transparent; }
    .slide-text h2 { font-size:2.6rem; margin:0 0 .4rem 0; }
    .slide-text p { margin:0 0 .8rem 0; font-size:1.05rem; }

    .slide-nav { position:absolute; top:50%; width:100%; display:flex; justify-content:space-between; transform:translateY(-50%); z-index:3; pointer-events:none; }
    .slide-nav button { pointer-events:auto; background:rgba(0,0,0,0.45); color:#fff; border:none; padding:8px 12px; font-size:1.6rem; cursor:pointer; border-radius:6px; margin:0 8px; }

    .dots { position:absolute; bottom:12px; width:100%; text-align:center; z-index:5; }
    .dot { display:inline-block; width:12px; height:12px; background:#fff; opacity:.6; border-radius:50%; margin:0 6px; cursor:pointer; }
    .dot.active { background:var(--accent); opacity:1; }

    /* Layout sections */
    main { max-width:var(--max-width); margin: 0 auto; padding: 1.6rem; }
    section { margin-bottom:2rem; }

    h2.section-title { margin:0 0 16px 0; font-size:1.4rem; color:#111; }

    /* Produk grid (mimic original) */
    .products-grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .card { background:var(--bg); border:1px solid #eee; border-radius:10px; padding:12px; display:flex; flex-direction:column; align-items:center; position:relative; overflow:visible; }
    .card .img-wrapper { position:relative; width:100%; max-width:220px; }
    .card img { width:100%; display:block; aspect-ratio:1/1; object-fit:cover; border-radius:8px; }
    .price { width:100%; padding:10px 0; text-align:center; font-weight:700; display:flex; gap:8px; align-items:center; justify-content:center; }
    .price .old { text-decoration:line-through; color:gray; font-weight:600; }
    .price .new { color:#d32f2f; font-weight:800; }

    .promo-label { position:absolute; top:10px; left:10px; background:red; color:#fff; padding:6px 8px; font-weight:700; border-radius:6px; display:none; z-index:6; font-size:0.8rem; }

    /* countdown overlay (inside image wrapper) */
    .countdown-overlay { position:absolute; bottom:0; left:0; width:100%; background:rgba(255,215,0,0.95); color:#000; font-weight:700; padding:6px 6px; text-align:center; border-bottom-left-radius:8px; border-bottom-right-radius:8px; font-size:0.9rem; z-index:7; }

    /* Galeri slider (horizontal) */
    .gallery-grid-wrapper { position:relative; overflow:hidden; }
    .gallery-grid { display:flex; gap:12px; transition:transform .45s ease; padding:8px 0; }
    .gallery-item { flex:0 0 280px; border-radius:10px; overflow:hidden; border:1px solid #e6e6e6; background:#fff; }
    .gallery-item img { width:100%; height:180px; object-fit:cover; display:block; }

    /* Testimonial slider */
    .testimonial-slider { display:flex; gap:12px; transition:transform .45s ease; }
    .testimonial-card { background:#fff; padding:12px; border-radius:10px; width:260px; box-shadow:0 2px 6px rgba(0,0,0,0.06); text-align:center; }
    .testimonial-card img { width:100%; height:160px; object-fit:cover; border-radius:10px; margin-bottom:8px; }

    /* Footer */
    footer { background:#111; color:#fff; padding:2rem 1.2rem; }
    .footer-inner { max-width:var(--max-width); margin:0 auto; display:flex; gap:20px; flex-wrap:wrap; justify-content:space-between; }
    .footer-info { flex:1 1 320px; }
    .footer-map iframe { width:100%; height:200px; border:0; border-radius:8px; }

    /* Video embed responsiveness */
    .video-wrapper { position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:8px; }
    .video-wrapper iframe { position:absolute; top:0; left:0; width:100%; height:100%; }

    /* Floating WA button & cart */
    .whatsapp-float { position:fixed; bottom:20px; right:20px; z-index:1200; }
    .whatsapp-float img { width:56px; height:56px; border-radius:50%; }

    .floating-cart { position:fixed; right:20px; top:45%; transform:translateY(-50%); background:var(--accent); color:#000; padding:12px; border-radius:50%; z-index:1200; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.15); }

    /* responsive rules */
    @media (max-width: 900px) {
      .slide-content { flex-direction:column; text-align:center; padding:16px; }
      .slide-content img { width:200px; }
      .menu-toggle { display:block; }
      .nav-desktop ul { display:none; }
      .header-bar { padding:10px; }
    }

    @media (max-width:520px) {
      .gallery-item { flex:0 0 180px; }
      .testimonial-card { width:200px; }
      .slide-text h2 { font-size:1.6rem; }
    }
</style>
</head>
<body>
<!-- Header / Navbar -->
  <header>
    <div class="header-bar">
      <div style="display:flex;align-items:center;gap:12px;">
        <button class="menu-toggle" id="menuToggle" aria-label="menu">‚ò∞</button>
        <div class="logo">
          <img id="site-logo" src="https://img.icons8.com/emoji/48/egg-emoji.png" alt="logo">
          <span id="brand-name">Sabiq Bejo</span>
        </div>
      </div>

      <nav>
        <div class="nav-desktop">
          <ul>
            <li><a href="#hero">Beranda</a></li>
            <li><a href="#products">Produk</a></li>
            <li><a href="#gallery">Galeri</a></li>
            <li><a href="#testimonials">Testimoni</a></li>
            <li><a href="#video">Video</a></li>
            <li><a href="#contact">Kontak</a></li>
          </ul>
        </div>
      </nav>

      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn-toggle" id="darkToggle" aria-label="toggle dark">üåô</button>
      </div>
    </div>
  </header>

  <!-- Hero Slider -->
  <div id="hero" aria-hidden="false">
    <div id="slidesContainer"></div>
    <div class="slide-nav">
      <button class="arrow arrow-left" id="prevSlide">‚ùÆ</button>
      <button class="arrow arrow-right" id="nextSlide">‚ùØ</button>
    </div>
    <div class="dots" id="dotsContainer"></div>
  </div>

  <!-- Main content -->
  <main>
    <!-- Produk -->
    <section id="products">
      <h2 class="section-title">Produk Unggulan</h2>
      <div id="productsGrid" class="products-grid"></div>
    </section>

    <!-- Galeri -->
    <section id="gallery">
      <h2 class="section-title">Galeri Produk & Kegiatan</h2>
      <div class="gallery-grid-wrapper">
        <div id="galleryGrid" class="gallery-grid"></div>
      </div>
    </section>

    <!-- Testimoni -->
    <section id="testimonials">
      <h2 class="section-title">Testimoni</h2>
      <div style="position:relative;">
        <div id="testiGrid" class="testimonial-slider"></div>
      </div>
    </section>

    <!-- Video -->
    <section id="video">
      <h2 class="section-title">Proses Produksi</h2>
      <p>Lihat proses produksi kami yang higienis dan terpercaya.</p>
      <div class="video-wrapper" id="videoWrapper">
        <!-- iframe akan dimasukkan via JS dari Pengaturan (atau default) -->
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="footer-inner">
      <div class="footer-info">
        <h3 id="footer-title">CV. Sabiq Bejo</h3>
        <p id="footer-desc">Produsen Telur Asin & Olahan Asin dari Lamongan.</p>
        <p><strong>Alamat:</strong> <span id="footer-address">-</span></p>
        <p><strong>Jam Buka:</strong> <span id="footer-hours">-</span></p>
        <p><strong>Kontak:</strong> <a id="footer-wa" href="#" style="color:var(--accent)">WhatsApp</a></p>
      </div>
      <div class="footer-map" id="footer-map">
        <!-- iframe maps dimasukkan via JS -->
      </div>
    </div>
  </footer>

  <!-- Floating WA button -->
  <a id="whatsappFloat" class="whatsapp-float" target="_blank" href="#">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="Chat via WA">
  </a>

  <!-- Floating cart -->
  <div class="floating-cart" id="floatingCart" title="Keranjang">üõí<span id="cartCount" style="position:relative; left:6px; font-weight:700; font-size:0.9rem;">0</span></div>

  <!-- ===== JS: Fetch API + Render ===== -->

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbw7z-KG3qwpi8-AkrMPGg2ONX_gWwepiN7oKPiAcx6n_fVBjASLZ79IMxsuV99tUisCwg/exec"; // URL Web App dari Apps Script
const API_TOKEN = "1_sE-EY0hPXT_mQBg7sifRUoDAon6DvQNQZcUsrwnD0A"; // sama dengan di Apps Script
const TIMEZONE = "Asia/Jakarta"; // format time lokal asumsi

    // util: aman fetch (menangani HTML error)
    async function safeFetch(url) {
      const res = await fetch(url, { cache: "no-cache" });
      const text = await res.text();
      // jika server mengembalikan HTML/error, deteksi '<!DOCTYPE' atau '<html'
      if (text.trim().startsWith("<")) {
        console.error("API returned HTML (not JSON):", text.slice(0, 500));
        throw new Error("Invalid API response (HTML). Periksa API_URL / deployment / token.");
      }
      try {
        return JSON.parse(text);
      } catch (err) {
        console.error("JSON parse error:", err, text.slice(0, 200));
        throw err;
      }
    }

    async function fetchSheet(sheetName) {
      const url = `${API_URL}?sheet=${encodeURIComponent(sheetName)}&token=${encodeURIComponent(API_TOKEN)}`;
      const json = await safeFetch(url);
      if (json.status && json.status === "success") return json.data;
      throw new Error(json.message || "Unknown API error");
    }

    /* ---------- Rendering helpers ---------- */
    function formatRupiah(n) {
      if (n === "" || n == null) return "-";
      const num = Number(n);
      if (isNaN(num)) return n;
      return num.toLocaleString('id-ID');
    }

    function parseHM(hm) {
      if (!hm) return null;
      const parts = String(hm).trim().split(":");
      if (parts.length < 2) return null;
      const h = parseInt(parts[0],10), m = parseInt(parts[1],10);
      if (isNaN(h) || isNaN(m)) return null;
      return {h,m};
    }

    function nowInMinutes() {
      const d = new Date();
      return d.getHours()*60 + d.getMinutes();
    }

    function hmToMinutes(hm) {
      if (!hm) return null;
      const p = parseHM(hm);
      return p ? p.h*60 + p.m : null;
    }

    function secToHMS(sec) {
      if (sec <= 0) return "0j 0m 0d";
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      const s = Math.floor(sec%60);
      return `${h}j ${m}m ${s}d`;
    }

    /* ---------- State ---------- */
    let productsState = []; // array produk dari API
    let promoBarActive = false;
    let slideIndex = 0;
    let slideIntervalId = null;

    /* ---------- Init app ---------- */
    async function init() {
      try {
        // ambil pengaturan dulu
        const settings = await fetchSheet("Pengaturan");
        applySettings(settings || []);

        // load slider
        const sliders = await fetchSheet("Slider");
        renderSlides(sliders || []);

        // load products
        productsState = await fetchSheet("Produk");
        renderProducts(productsState || []);

        // load gallery
        const gallery = await fetchSheet("Galeri");
        renderGallery(gallery || []);

        // load testimonials
        const testis = await fetchSheet("Testimoni");
        renderTestimonials(testis || []);

        // setup slider autoplay
        startSlideAuto();

        // start countdown tick every 1s to update countdown overlays
        setInterval(tickCountdowns, 1000);

      } catch (err) {
        console.error("Init error:", err);
        // minimal degrade: tampilkan pesan pada halaman
        document.getElementById("productsGrid").innerHTML = "<p style='color:tomato'>Gagal memuat data. Periksa API URL / token / koneksi.</p>";
      }
    }

    /* ---------- Apply Pengaturan ---------- */
    function applySettings(settings) {
      // settings: array [{key,value},...]
      const map = {};
      settings.forEach(r => {
        const k = (r.key || "").toString().trim().toLowerCase();
        const v = r.value != null ? r.value : "";
        map[k] = v;
      });

      if (map.site_title) document.getElementById("site-title").textContent = map.site_title;
      if (map.logo) document.getElementById("site-logo").src = map.logo;
      if (map.site_title) document.getElementById("brand-name").textContent = map.site_title;
      if (map.icon) document.getElementById("favicon").href = map.icon;
      if (map.warna) {
        document.documentElement.style.setProperty("--accent", map.warna);
      }
      if (map.textpromo) {
        document.getElementById("promo-text").textContent = map.textpromo;
      }
      if (map.wa) {
        const waLink = `https://wa.me/${map.wa}?text=${encodeURIComponent(map.wa_message || "")}`;
        document.getElementById("whatsappFloat").href = waLink;
        const waEl = document.getElementById("footer-wa");
        waEl.href = waLink; waEl.textContent = map.wa;
      }
      if (map.seo_description) {
        let meta = document.querySelector('meta[name="description"]');
        if (meta) meta.content = map.seo_description;
      }
      if (map.alamat) document.getElementById("footer-address").textContent = map.alamat;
      if (map.jam_buka) document.getElementById("footer-hours").textContent = map.jam_buka;
      if (map.maps) {
        document.getElementById("footer-map").innerHTML = `<iframe src="${map.maps}" loading="lazy"></iframe>`;
      }
      // video embed if available
      if (map.video_embed) {
        document.getElementById("videoWrapper").innerHTML = `<iframe src="${map.video_embed}" frameborder="0" allowfullscreen></iframe>`;
      } else {
        // default video (YouTube)
        document.getElementById("videoWrapper").innerHTML = `<iframe src="https://www.youtube.com/embed/B5njr5BoGo8" frameborder="0" allowfullscreen></iframe>`;
      }
    }

    /* ---------- Slides rendering ---------- */
    function renderSlides(sliders) {
      const container = document.getElementById("slidesContainer");
      const dots = document.getElementById("dotsContainer");
      container.innerHTML = "";
      dots.innerHTML = "";

      if (!sliders || sliders.length === 0) {
        // fallback slide
        const el = document.createElement("div");
        el.className = "slide active";
        el.style.backgroundImage = "url('https://via.placeholder.com/1200x600?text=Promo')";
        el.innerHTML = `<div class="slide-content"><img src="https://img.icons8.com/emoji/96/egg-emoji.png" alt="logo"><div class="slide-text"><h2>Sabiq Bejo</h2><p>Produsen Telur Asin Lamongan</p><a class="btn" href="#products">Lihat Produk</a></div></div>`;
        container.appendChild(el);
        dots.innerHTML = `<span class="dot active"></span>`;
        return;
      }

      sliders.forEach((s, i) => {
        const bg = s.bg_image_url || s.image_url || "";
        const img = s.image_url || s.bg_image_url || "";
        const alt = s.alt || "";
        const title = s.judul_slider || "";
        const ket = s.ket_slider || "";
        const btnText = s.tombol_text || "Lihat";
        const btnLink = s.tombol_link || "#products";

        const slide = document.createElement("div");
        slide.className = "slide" + (i===0 ? " active":"");
        slide.style.backgroundImage = bg ? `url('${bg}')` : `linear-gradient(90deg,#333,#666)`;
        slide.innerHTML = `<div class="slide-content">
            <img src="${img}" alt="${alt}">
            <div class="slide-text">
              <h2>${escapeHtml(title)}</h2>
              <p>${escapeHtml(ket)}</p>
              <a class="btn" href="${btnLink}">${escapeHtml(btnText)}</a>
            </div>
          </div>`;
        container.appendChild(slide);

        const dot = document.createElement("span");
        dot.className = "dot" + (i===0 ? " active":"");
        dot.dataset.index = i;
        dot.addEventListener("click", () => showSlide(parseInt(dot.dataset.index)));
        dots.appendChild(dot);
      });
    }

    function showSlide(n) {
      const slides = document.querySelectorAll("#slidesContainer .slide");
      const dots = document.querySelectorAll("#dotsContainer .dot");
      if (!slides.length) return;
      slideIndex = (n + slides.length) % slides.length;
      slides.forEach((s,i)=> s.classList.toggle("active", i===slideIndex));
      dots.forEach((d,i)=> d.classList.toggle("active", i===slideIndex));
    }

    function startSlideAuto() {
      if (slideIntervalId) clearInterval(slideIntervalId);
      slideIntervalId = setInterval(()=> {
        showSlide(slideIndex+1);
      }, 5000);
      document.getElementById("prevSlide").addEventListener("click", ()=> { showSlide(slideIndex-1); startSlideAuto(); });
      document.getElementById("nextSlide").addEventListener("click", ()=> { showSlide(slideIndex+1); startSlideAuto(); });
    }

    /* ---------- Products rendering & countdown ---------- */
    function renderProducts(products) {
      const grid = document.getElementById("productsGrid");
      grid.innerHTML = "";

      if (!products || products.length === 0) {
        grid.innerHTML = "<p>Tidak ada produk untuk ditampilkan.</p>";
        return;
      }

      // standardize keys: lower-case trimmed to match Apps Script output
      products.forEach((p, idx) => {
        const promostart = (p.promostart||"").toString().trim();
        const promoend = (p.promoend||"").toString().trim();
        const hargaawal = p.hargaawal || p.price || p.harga || "";
        const hargadiskon = p.hargadiskon || p.hargadiskon || "";
        const img = p.gbrproduk || p.gambar || p.image || "";
        const alt = p.alt || "";
        const nama = p.namaproduk || p.nama || p.name || "Produk";
        const aktif = (p.aktif || "yes").toString().toLowerCase() === "yes";

        // create card
        const card = document.createElement("div");
        card.className = "card";
        if (!aktif) card.style.opacity = "0.7";

        // promo badge
        const promoBadge = document.createElement("div");
        promoBadge.className = "promo-label";
        promoBadge.textContent = "PROMO";

        // image wrapper + overlay
        const imgWrap = document.createElement("div");
        imgWrap.className = "img-wrapper";
        const imgEl = document.createElement("img");
        imgEl.src = img || "https://via.placeholder.com/400x400?text=No+Image";
        imgEl.alt = alt || nama;
        imgWrap.appendChild(imgEl);

        const countdownEl = document.createElement("div");
        countdownEl.className = "countdown-overlay";
        countdownEl.style.display = "none";
        countdownEl.dataset.start = promostart;
        countdownEl.dataset.end = promoend;
        imgWrap.appendChild(countdownEl);

        // title & price
        const title = document.createElement("h3");
        title.style.margin = "10px 0 6px 0";
        title.textContent = nama;

        const priceWrap = document.createElement("div");
        priceWrap.className = "price";
        const oldSpan = document.createElement("span");
        oldSpan.className = "old";
        oldSpan.style.display = "none";
        oldSpan.textContent = "Rp " + formatRupiah(hargaawal);

        const newSpan = document.createElement("span");
        newSpan.className = "new";
        // set default tampil harga (script will update later)
        newSpan.textContent = "Rp " + formatRupiah(hargadiskon || hargaawal);

        priceWrap.appendChild(oldSpan);
        priceWrap.appendChild(newSpan);

        // stars + button area
        const stars = document.createElement("div");
        stars.className = "stars";
        stars.textContent = "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ";
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.style.marginTop = "8px";
        btn.textContent = "Tambah ke Keranjang";
        btn.addEventListener("click", ()=> addToCart(nama, Number(hargadiskon || hargaawal)));

        // assemble card
        card.appendChild(promoBadge);
        card.appendChild(imgWrap);
        card.appendChild(title);
        card.appendChild(priceWrap);
        card.appendChild(stars);
        card.appendChild(btn);

        // attach dataset for updates
        card.dataset.promostart = promostart;
        card.dataset.promoend = promoend;
        card.dataset.hargaawal = hargaawal;
        card.dataset.hargadiskon = hargadiskon;
        card.dataset.aktif = aktif ? "yes" : "no";

        grid.appendChild(card);

        // initial set promo display based on server-provided field (if present)
        // but to be robust, we compute client-side next tick
      });

      // initial tick to set countdowns and promos
      tickCountdowns();
    }

    // update countdown for all cards each second
    function tickCountdowns() {
      const cards = document.querySelectorAll("#productsGrid .card");
      let anyPromoActive = false;

      cards.forEach(card => {
        const start = card.dataset.promostart;
        const end = card.dataset.promoend;
        const hargaawal = card.dataset.hargaawal;
        const hargadiskon = card.dataset.hargadiskon;

        const countdownEl = card.querySelector(".countdown-overlay");
        const promoBadge = card.querySelector(".promo-label");
        const oldSpan = card.querySelector(".price .old");
        const newSpan = card.querySelector(".price .new");

        // no promo times => hide promo UI
        if (!start || !end) {
          if (countdownEl) countdownEl.style.display = "none";
          if (promoBadge) promoBadge.style.display = "none";
          if (oldSpan) oldSpan.style.display = "none";
          if (newSpan) newSpan.textContent = "Rp " + formatRupiah(hargaawal);
          return;
        }

        const now = new Date();
        const nowMinutes = now.getHours()*60 + now.getMinutes();
        const startMin = hmToMinutes(start);
        const endMin = hmToMinutes(end);

        // handle day wrap (if end < start assume next day)
        let effectiveEndMin = endMin;
        if (endMin < startMin) { // promo crosses midnight
          // if now >= start OR now <= end -> active
          if (nowMinutes >= startMin || nowMinutes <= endMin) {
            // compute seconds until tomorrow end
            let endDate = new Date(now);
            if (nowMinutes >= startMin) {
              // end is tomorrow
              endDate.setDate(endDate.getDate()+1);
            }
            endDate.setHours(parseInt(end.split(":")[0],10), parseInt(end.split(":")[1],10), 0, 0);
            const secsLeft = Math.floor((endDate - now)/1000);
            countdownEl.textContent = secToHMS(secsLeft);
            countdownEl.style.display = "block";
            promoBadge.style.display = "inline-block";
            oldSpan.style.display = hargadiskon ? "inline-block" : "none";
            newSpan.textContent = "Rp " + formatRupiah(hargadiskon || hargaawal);
            anyPromoActive = true;
            return;
          } else {
            // not active
            countdownEl.style.display = "none";
            promoBadge.style.display = "none";
            oldSpan.style.display = "none";
            newSpan.textContent = "Rp " + formatRupiah(hargaawal);
            return;
          }
        }

        // normal same-day promo window
        if (startMin <= nowMinutes && nowMinutes <= endMin) {
          // active
          const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(end.split(":")[0],10), parseInt(end.split(":")[1],10), 0);
          const secsLeft = Math.floor((endDate - now)/1000);
          countdownEl.textContent = secToHMS(secsLeft);
          countdownEl.style.display = "block";
          promoBadge.style.display = "inline-block";
          oldSpan.style.display = hargadiskon ? "inline-block" : "none";
          newSpan.textContent = "Rp " + formatRupiah(hargadiskon || hargaawal);
          anyPromoActive = true;
        } else {
          // inactive
          countdownEl.style.display = "none";
          promoBadge.style.display = "none";
          oldSpan.style.display = "none";
          newSpan.textContent = "Rp " + formatRupiah(hargaawal);
        }
      });

      // show/hide promo bar on top
      const promoBar = document.getElementById("promo-bar");
      if (anyPromoActive) {
        if (!promoBarActive) {
          promoBar.style.display = "block";
          promoBarActive = true;
        }
      } else {
        if (promoBarActive) {
          promoBar.style.display = "none";
          promoBarActive = false;
        }
      }
    }

    /* ---------- Gallery rendering ---------- */
    function renderGallery(items) {
      const g = document.getElementById("galleryGrid");
      g.innerHTML = "";
      if (!items || items.length === 0) {
        g.innerHTML = "<p>Tidak ada galeri</p>";
        return;
      }
      items.forEach(it => {
        const imgUrl = it.gambar_url || it.image || "";
        const alt = it.alt_text || "";
        const card = document.createElement("div");
        card.className = "gallery-item";
        card.innerHTML = `<img src="${imgUrl||'https://via.placeholder.com/600x400?text=No+Image'}" alt="${escapeHtml(alt)}">`;
        g.appendChild(card);
      });
      // optional: implement horizontal nav (left/right) if wanted
    }

    /* ---------- Testimonial rendering ---------- */
    function renderTestimonials(items) {
      const t = document.getElementById("testiGrid");
      t.innerHTML = "";
      if (!items || items.length === 0) {
        t.innerHTML = "<p>Tidak ada testimoni</p>";
        return;
      }
      items.forEach(it => {
        const name = it.nama || it.name || "Anon";
        const job = it.jabatan || it.role || "";
        const img = it.gambar_url || it.image || "https://via.placeholder.com/300x200?text=User";
        const card = document.createElement("div");
        card.className = "testimonial-card";
        card.innerHTML = `<img src="${img}" alt="${escapeHtml(name)}"><p><strong>${escapeHtml(name)}</strong><br><small>${escapeHtml(job)}</small></p>`;
        t.appendChild(card);
      });
    }

    /* ---------- Cart simple implementation ---------- */
    const cart = [];
    function addToCart(name, price) {
      const existing = cart.find(i => i.name === name);
      if (existing) existing.qty++;
      else cart.push({name, price, qty:1});
      renderCartCount();
    }
    function renderCartCount() {
      const count = cart.reduce((s,i)=> s + (i.qty || 0), 0);
      document.getElementById("cartCount").textContent = count;
    }

    /* ---------- util escapeHtml ---------- */
    function escapeHtml(s) {
      if (s == null) return "";
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
    }

    /* ---------- event listeners ---------- */
    document.getElementById("darkToggle").addEventListener("click", ()=>{
      document.body.classList.toggle("dark-mode");
    });
    document.getElementById("menuToggle").addEventListener("click", ()=>{
      const side = document.getElementById("sideMenu");
      if (side) side.classList.toggle("active");
    });

    /* init app */
    init();
</script>

</body>
</html>
