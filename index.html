<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title id="site-title">Sabiq Bejo</title>
  <meta id="meta-desc" name="description" content="Telur asin & olahan khas Lamongan ‚Äì CV. Sabiq Bejo.">
  <link id="favicon" rel="icon" href="https://img.icons8.com/emoji/48/egg-emoji.png" type="image/png">

  <!-- Swiper CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"/>

  <style>
    :root{
      --header-h:64px;
      --primary:#121212;
      --accent:#ffd700;
      --bg:#ffffff;
      --card:#ffffff;
      --text:#222222;
      --muted:#777;
      --border:#e9e9e9;
      --maxw:1200px;
    }
    body.dark{
      --primary:#0b0b0b;
      --bg:#070707;
      --card:#0f0f0f;
      --text:#eaeaea;
      --muted:#a8a8a8;
      --border:#222;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial; -webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;height:auto;display:block}

    /* header fixed */
    header{
      position:fixed;
      top:0;
      left:0;
      right:0;
      height:var(--header-h);
      background:var(--primary);
      color:var(--accent);
      z-index:2200;
      display:flex;
      align-items:center;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
    }
    .header-inner{max-width:var(--maxw);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:0 16px;width:100%}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--accent)}
    .logo img{width:36px;height:36px;border-radius:6px}
    nav ul{display:flex;gap:14px;list-style:none;margin:0;padding:0;align-items:center}
    nav a{color:var(--accent);font-weight:700}
    .menu-toggle{display:none;background:none;border:0;color:var(--accent);font-size:1.8rem}

    .btn{background:none;color:var(--accent);border:1px solid var(--accent);padding:.45rem .7rem;border-radius:8px;cursor:pointer}

    /* ensure main content not hidden by fixed header */
    main{padding-top:calc(var(--header-h) + 18px);max-width:var(--maxw);margin:0 auto;padding-left:16px;padding-right:16px}

    /* promo marquee */
    .promo-marquee{display:none;background:linear-gradient(90deg,var(--accent),#ffec9a);color:#000;font-weight:800;padding:.45rem;text-align:center;position:fixed;top:var(--header-h);left:0;right:0;z-index:2150}
    .promo-marquee span{display:inline-block;padding-left:100%;animation:marq 15s linear infinite}
    @keyframes marq {0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

    /* hero */
    #hero{height:min(86vh,820px);margin-top:8px}
    .swiper-hero,.swiper-hero .swiper-wrapper,.swiper-hero .swiper-slide{height:100%}
    .hero-slide{background-size:cover;background-position:center;display:flex;align-items:center;justify-content:center;position:relative}
    .hero-overlay{position:absolute;inset:0;background:linear-gradient(rgba(0,0,0,.28),rgba(0,0,0,.5));z-index:1}
    .slide-content{position:relative;z-index:2;display:flex;gap:24px;align-items:center;max-width:1100px;padding:28px;color:#fff}
    .slide-img{width:240px;aspect-ratio:1/1;object-fit:contain;border-radius:12px}
    .slide-text h2{font-size:2.8rem;margin:0}
    .slide-text p{margin:.6rem 0 1rem;color:#fffdd0}
    .cta{display:inline-block;background:var(--accent);color:#000;padding:.6rem .9rem;border-radius:10px;font-weight:800}

    /* products */
    .products-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;position:relative;overflow:visible;display:flex;flex-direction:column;align-items:center}
    .img-wrapper{position:relative;width:100%;max-width:280px}
    .img-wrapper img{width:100%;height:auto;border-radius:10px;aspect-ratio:1/1;object-fit:cover;cursor:zoom-in}
    .promo-label{position:absolute;top:10px;left:10px;background:var(--accent);color:#000;padding:6px 8px;font-weight:800;border-radius:8px;display:none;z-index:8}
    .countdown-overlay{position:absolute;bottom:0;left:0;width:100%;background:rgba(255,215,0,0.98);color:#000;font-weight:800;padding:6px 8px;text-align:center;border-bottom-left-radius:10px;border-bottom-right-radius:10px;z-index:9;display:none}
    .card h3{margin:10px 0 6px 0;text-align:center}
    .price{display:flex;gap:8px;align-items:center;justify-content:center;width:100%}
    .price .old{text-decoration:line-through;color:gray;display:none}
    .price .new{color:#d32f2f;font-weight:900}

    /* gallery/testi */
    .gallery-item img{height:180px;object-fit:cover;border-radius:10px;cursor:zoom-in}
    .testimonial-card{background:var(--card);padding:12px;border-radius:12px;text-align:center}
    .testimonial-card img{width:100%;height:140px;object-fit:cover;border-radius:8px;margin-bottom:8px}

    /* footer */
    footer{background:#111;color:#fff;padding:28px 12px;margin-top:28px}
    .footer-inner{max-width:var(--maxw);margin:0 auto;display:flex;gap:20px;flex-wrap:wrap;justify-content:space-between}

    /* floating cluster (scroll-top, WA, cart) */
    .float-cluster{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:12px;align-items:center;z-index:2300}
    .float-btn{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--card);box-shadow:0 6px 18px rgba(0,0,0,.15);cursor:pointer;border:1px solid var(--border)}
    .float-btn .emoji{font-size:20px}
    .float-top{background:rgba(0,0,0,.75);color:#fff}
    .float-wa img{width:34px;height:34px}
    .float-cart{background:var(--accent);color:#000;position:relative}
    .cart-badge{position:absolute;top:-6px;right:-6px;background:#e53935;color:#fff;padding:5px 8px;border-radius:999px;font-weight:800;font-size:.85rem;display:none}

    /* cart panel */
    .cart-panel{position:fixed;right:-100%;top:0;height:100%;width:360px;max-width:92%;background:var(--card);box-shadow:-6px 0 24px rgba(0,0,0,.2);z-index:2400;padding:18px;transition:right .28s;overflow:auto;border-left:1px solid var(--border)}
    .cart-panel.active{right:0}
    .close-cart{position:absolute;top:10px;right:10px;background:none;border:0;font-size:22px;cursor:pointer;border-radius:6px;padding:6px}
    /* contrast close in dark mode */
    body.dark .close-cart{background:var(--accent);color:#000}

    .cart-item{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:10px 0;border-bottom:1px dashed var(--border)}
    .qty-controls{display:flex;gap:8px;align-items:center}
    .qty-controls button{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;cursor:pointer}
    body.dark .qty-controls button{background:#222;color:#fff}

    /* mobile: bigger text in cart */
    @media(max-width:640px){
      .cart-panel{width:92%}
      .cart-panel{font-size:1.15rem}
      .cart-panel .cart-item .qty-controls button{padding:8px 12px}
      .offcanvas-left nav a{font-size:2.1rem}
      .slide-text h2{font-size:1.6rem}
    }

    /* Zoom overlay */
    .zoom-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:2600;display:none;align-items:center;justify-content:center}
    .zoom-overlay.show{display:flex}
    .zoom-img{max-width:92vw;max-height:92vh;border-radius:8px;transform-origin:center center;transition:transform .08s linear}
    .zoom-controls{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;gap:8px}
    .zoom-controls button{background:#fff;border:0;padding:8px 12px;border-radius:8px;font-weight:800;cursor:pointer}
    .zoom-close{position:fixed;top:16px;right:16px;background:#fff;border-radius:8px;border:0;padding:6px 10px;font-weight:900;cursor:pointer}
    body.dark .zoom-close{background:var(--accent);color:#000}

    /* responsive */
    @media(max-width:900px){
      .menu-toggle{display:block}
      nav ul{display:none}
    }
  </style>
</head>
<body>

  <!-- Loading -->
  <div id="loadingOverlay"><div class="spinner" role="status" aria-hidden="true"></div></div>

  <!-- Promo marquee (fixed just under header) -->
  <div id="promo-bar" class="promo-marquee" style="display:none"><a id="promo-link" href="#products"><span id="promo-text">üî• FLASH SALE ‚Äî Diskon Terbatas! üî•</span></a></div>

  <!-- Header fixed -->
  <header>
    <div class="header-inner">
      <div style="display:flex;align-items:center;gap:12px">
        <button id="menuToggle" class="menu-toggle" aria-label="Menu">‚ò∞</button>
        <div class="logo">
          <img id="site-logo" src="https://img.icons8.com/emoji/48/egg-emoji.png" alt="logo">
          <div>
            <div id="brand-name">Sabiq Bejo</div>
            <div id="brand-sub" style="font-size:.85rem;color:var(--muted)"></div>
          </div>
        </div>
      </div>

      <nav>
        <ul id="navList">
          <li><a href="#hero">Beranda</a></li>
          <li><a href="#products">Produk</a></li>
          <li><a href="#gallery">Galeri</a></li>
          <li><a href="#testimonials">Testimoni</a></li>
          <li><a href="#video">Video</a></li>
          <li><a href="#contact">Kontak</a></li>
        </ul>
      </nav>

      <div style="display:flex;gap:10px;align-items:center;position:relative">
        <button id="darkToggle" class="btn" title="Dark Mode">üåô</button>
      </div>
    </div>
  </header>

  <!-- Off-canvas mobile menu -->
  <div id="offcanvasLeft" class="offcanvas-left" aria-hidden="true" style="display:none">
    <button class="offcanvas-close" id="offLeftClose">√ó</button>
    <nav>
      <ul>
        <li><a href="#hero" class="off-link">Beranda</a></li>
        <li><a href="#products" class="off-link">Produk</a></li>
        <li><a href="#gallery" class="off-link">Galeri</a></li>
        <li><a href="#testimonials" class="off-link">Testimoni</a></li>
        <li><a href="#video" class="off-link">Video</a></li>
        <li><a href="#contact" class="off-link">Kontak</a></li>
      </ul>
    </nav>
  </div>

  <!-- HERO -->
  <section id="hero">
    <div class="swiper swiper-hero" id="swiperHero">
      <div class="swiper-wrapper" id="slidesContainer">
        <!-- slides injected by JS -->
      </div>
      <div class="hero-overlay"></div>
      <div class="swiper-pagination"></div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>
  </section>

  <main>
    <!-- Products -->
    <section id="products">
      <h2 class="section-title">Produk Unggulan</h2>
      <div id="productsGrid" class="products-grid" data-exclusive="false">
        <!-- skeleton cards before render -->
        <div class="card skeleton" style="height:320px"></div>
        <div class="card skeleton" style="height:320px"></div>
        <div class="card skeleton" style="height:320px"></div>
      </div>
    </section>

    <!-- Gallery -->
    <section id="gallery" class="gallery-section">
      <h2 class="section-title">Galeri Produk & Kegiatan</h2>
      <div class="swiper" id="gallerySwiper">
        <div class="swiper-wrapper" id="galleryGrid">
          <div class="swiper-slide skeleton" style="height:180px"></div>
        </div>
        <div class="swiper-pagination"></div>
      </div>
    </section>

    <!-- Testimonials -->
    <section id="testimonials" class="testi-section">
      <h2 class="section-title">Testimoni</h2>
      <div class="swiper" id="testiSwiper">
        <div class="swiper-wrapper" id="testiGrid">
          <div class="swiper-slide skeleton" style="height:160px"></div>
        </div>
        <div class="swiper-pagination"></div>
      </div>
    </section>

    <!-- Video -->
    <section id="video">
      <h2 class="section-title">Proses Produksi</h2>
      <div class="video-wrapper" id="videoWrapper">
        <iframe src="https://www.youtube.com/embed/B5njr5BoGo8" frameborder="0" allowfullscreen loading="lazy"></iframe>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer id="contact">
    <div class="footer-inner">
      <div class="footer-info">
        <h3 id="footer-title">CV. Sabiq Bejo</h3>
        <p id="footer-desc">Produsen Telur Asin & Olahan dari Lamongan.</p>
        <p><strong>Alamat:</strong> <span id="footer-address">-</span></p>
        <p><strong>Jam Buka:</strong> <span id="footer-hours">-</span></p>
        <p><strong>Kontak:</strong> <a id="footer-wa" href="#" target="_blank" rel="noopener">WhatsApp</a></p>
      </div>
      <div class="footer-map" id="footer-map"></div>
    </div>
  </footer>

  <!-- Cart Panel -->
  <aside id="cartPanel" class="cart-panel" aria-hidden="true">
    <button class="close-cart" id="closeCartPanel" title="Tutup">√ó</button>
    <h3>Review Pesanan</h3>
    <div id="cartItemsList" style="overflow:auto;max-height:60vh"></div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Total:</strong><div id="cartTotal">Rp 0</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="clearCart" class="btn">Kosongkan</button>
      <button id="checkoutBtn" class="btn" style="background:var(--accent);border:none;color:#000">Checkout via WA</button>
    </div>
  </aside>

  <!-- Floating cluster: scroll-top, WA, Cart -->
  <div class="float-cluster" aria-hidden="false">
    <div id="scrollTopBtn" class="float-btn float-top" title="Scroll ke atas" aria-label="Scroll ke atas">
      <span class="emoji">‚¨ÜÔ∏è</span>
    </div>
    <a id="whatsappFloat" class="float-btn float-wa" target="_blank" rel="noopener" title="Chat WA">
      <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WA">
    </a>
    <div id="cartFloatBtn" class="float-btn float-cart" title="Keranjang">
      <span class="emoji">üõí</span>
      <span id="cartBadge" class="cart-badge" style="display:none">0</span>
    </div>
  </div>

  <!-- Zoom overlay -->
  <div id="zoomOverlay" class="zoom-overlay" aria-hidden="true">
    <button class="zoom-close" id="zoomClose" title="Tutup">‚úï</button>
    <img id="zoomImg" class="zoom-img" alt="Zoomed">
    <div class="zoom-controls">
      <button id="zoomOut">‚àí</button>
      <button id="zoomReset">100%</button>
      <button id="zoomIn">+</button>
    </div>
  </div>

  <!-- Swiper JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

  <script>
  /***** CONFIG *****/
  const API_URL = "https://script.google.com/macros/s/AKfycbw7z-KG3qwpi8-AkrMPGg2ONX_gWwepiN7oKPiAcx6n_fVBjASLZ79IMxsuV99tUisCwg/exec";
  const API_TOKEN = "1_sE-EY0hPXT_mQBg7sifRUoDAon6DvQNQZcUsrwnD0A";
  const LOCALE = "id-ID";
  /******************/

  // helpers
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from((ctx||document).querySelectorAll(sel));
  const fmtRupiah = v => { if(v==null||v==='') return '-'; const n=Number(String(v).replace(/\D/g,'')); return n.toLocaleString(LOCALE); };

  // state
  let SETTINGS = {};
  let SLIDES = [], PRODUCTS = [], GALLERY = [], TESTIS = [];
  let cart = [];
  let heroSwiper, gallerySwiper, testiSwiper;
  const loadingEl = $('#loadingOverlay');

  // safety JSON fetch
  function safeParseJSON(t){ try{return JSON.parse(t);}catch(e){return null;} }
  async function safeFetch(url){
    const res = await fetch(url, {cache:'no-cache'});
    const txt = await res.text();
    if(txt.trim().startsWith('<')) throw new Error('API returned HTML - wrong URL/deploy');
    const j = safeParseJSON(txt);
    if(!j) throw new Error('Invalid JSON from API');
    return j;
  }

  // fetch sheet
  async function fetchSheet(name){
    const url = `${API_URL}?sheet=${encodeURIComponent(name)}&token=${encodeURIComponent(API_TOKEN)}`;
    const data = await safeFetch(url);
    if(Array.isArray(data)) return data;
    if(data.status === 'success') return data.data || [];
    return [];
  }

  // normalize utilities (support various column names)
  function getAny(obj, keys){ for(const k of keys) if(obj[k]!==undefined && obj[k]!==null && obj[k]!=='') return obj[k]; return ''; }
  function nmSlides(rows){ return (rows||[]).map(r=>({ bg:getAny(r,['bg','bg_image','bg image','bg_image_url']), img:getAny(r,['image','image_url','gbr','gbr image','gbr_image','gbrproduk']), alt:getAny(r,['alt','alt_text']), title:getAny(r,['judulslider','title','judul']), caption:getAny(r,['ketslider','ket','caption']), buttonText:getAny(r,['tombol','button']), buttonLink:getAny(r,['tombol_link','button_link']) })); }
  function nmProducts(rows){ return (rows||[]).map((r,i)=>({ id:getAny(r,['id','ID'])||'p'+i, nama:getAny(r,['nama','name','nama produk']), gbr:getAny(r,['gbrproduk','gbr','gambar','image']), alt:getAny(r,['alt','alt_text']), hargaawal:getAny(r,['hargaawal','price','harga']), hargadiskon:getAny(r,['hargadiskon','hargadisc','diskon']), promostart:getAny(r,['promostart','promo_start']), promoend:getAny(r,['promoend','promo_end']), aktif: String(getAny(r,['aktif','active','aktif']))?.toLowerCase()==='yes' || getAny(r,['aktif','active','aktif'])==='' || getAny(r,['aktif','active','aktif'])==null ? true : (String(getAny(r,['aktif','active','aktif'])).toLowerCase()==='yes') })); }
  function nmGallery(rows){ return (rows||[]).map(r=>({ url:getAny(r,['gambar_url','image','url']), alt:getAny(r,['alt_text','alt']) })); }
  function nmTesti(rows){ return (rows||[]).map(r=>({ nama:getAny(r,['nama','name']), jabatan:getAny(r,['jabatan','role','position']), gambar:getAny(r,['gambar','image']) })); }

  // apply settings map (rows: key/value)
  function mapRows(rows){
    const m = {};
    (rows||[]).forEach(r=>{
      if(r.key && r.value){ m[String(r.key).trim().toLowerCase()] = r.value; }
      else {
        const ks = Object.keys(r);
        if(ks.length>=2) m[String(r[ks[0]]).trim().toLowerCase()] = r[ks[1]];
      }
    });
    return m;
  }
  function applySettings(map){
    SETTINGS = map||{};
    if(SETTINGS['site title']||SETTINGS.site_title) document.title = SETTINGS['site title']||SETTINGS.site_title;
    if(SETTINGS.logo) $('#site-logo').src = SETTINGS.logo;
    if(SETTINGS.icon) $('#favicon').href = SETTINGS.icon;
    if(SETTINGS.warna) document.documentElement.style.setProperty('--accent', SETTINGS.warna);
    if(SETTINGS.textpromo) $('#promo-text').textContent = SETTINGS.textpromo;
    if(SETTINGS.wa){
      $('#whatsappFloat').href = `https://wa.me/${SETTINGS.wa}?text=${encodeURIComponent(SETTINGS['wa message']||SETTINGS.wa_message||'')}`;
      $('#footer-wa').href = `https://wa.me/${SETTINGS.wa}`;
      $('#footer-wa').textContent = SETTINGS.wa;
    }
    if(SETTINGS.alamat) $('#footer-address').textContent = SETTINGS.alamat;
    if(SETTINGS['jam buka']) $('#footer-hours').textContent = SETTINGS['jam buka'];
    if(SETTINGS.maps){
      const frame = document.createElement('iframe');
      frame.loading='lazy';
      frame.src = SETTINGS.maps;
      frame.style.width='100%'; frame.style.height='220px'; frame.style.border='0'; frame.style.borderRadius='8px';
      $('#footer-map').innerHTML=''; $('#footer-map').appendChild(frame);
      // fallback to link if iframe fails to load after a few seconds
      const holder = $('#footer-map');
      let fallbackTimer = setTimeout(()=> {
        holder.innerHTML = `<a href="${SETTINGS.maps}" target="_blank" rel="noopener" style="color:#fff;text-decoration:underline;">Buka peta (klik jika embed diblokir)</a>`;
      }, 6000);
      frame.addEventListener('load', ()=> clearTimeout(fallbackTimer), {once:true});
    }
    if(SETTINGS.video_embed) $('#videoWrapper').innerHTML = `<iframe src="${SETTINGS.video_embed}" frameborder="0" allowfullscreen loading="lazy"></iframe>`;
  }

  // renderers
  function renderHero(){
    const c = $('#slidesContainer'); c.innerHTML='';
    if(!SLIDES.length) SLIDES = [{bg:'https://images.unsplash.com/photo-1514511547113-1be72277b32e?auto=format&fit=crop&w=1600&q=60', img:'https://img.icons8.com/emoji/96/egg-emoji.png', title:'Sabiq Bejo', caption:'Telur Asin Lamongan', buttonText:'Pesan', buttonLink:'#products'}];
    SLIDES.forEach(s=>{
      const slide = document.createElement('div'); slide.className='swiper-slide hero-slide';
      if(s.bg) slide.style.backgroundImage = `url('${s.bg}')`;
      slide.innerHTML = `<div class="hero-overlay"></div><div class="slide-content">
        ${s.img ? `<img class="slide-img" src="${s.img}" alt="${escapeHtml(s.alt||'')}" loading="lazy">` : ''}
        <div class="slide-text"><h2>${escapeHtml(s.title||'')}</h2><p>${escapeHtml(s.caption||'')}</p>${s.buttonText?`<a class="cta" href="${s.buttonLink||'#'}">${escapeHtml(s.buttonText)}</a>`:''}</div>
      </div>`;
      c.appendChild(slide);
    });
  }

  function renderProducts(){
    const grid = $('#productsGrid'); grid.innerHTML='';
    if(!PRODUCTS.length){ grid.innerHTML = '<p>Tidak ada produk</p>'; return; }
    PRODUCTS.forEach((p,idx)=>{
      const card = document.createElement('div'); card.className='card'; if(!p.aktif) card.style.opacity='.6';
      card.dataset.start = p.promostart||'';
      card.dataset.end = p.promoend||'';
      card.dataset.hargaawal = p.hargaawal||'';
      card.dataset.hargadiskon = p.hargadiskon||'';
      card.dataset.id = p.id || `p${idx}`;
      card.dataset.name = p.nama || `Produk ${idx+1}`;

      const promoLabel = document.createElement('div'); promoLabel.className='promo-label'; promoLabel.textContent='PROMO'; card.appendChild(promoLabel);

      const iw = document.createElement('div'); iw.className='img-wrapper';
      const img = document.createElement('img'); img.src = p.gbr || 'https://via.placeholder.com/400x400?text=No+Image'; img.alt = p.alt || p.nama; img.loading='lazy'; img.setAttribute('data-zoom','1');
      iw.appendChild(img);
      const co = document.createElement('div'); co.className='countdown-overlay'; co.style.display='none'; iw.appendChild(co);
      card.appendChild(iw);

      const h3 = document.createElement('h3'); h3.textContent = p.nama || 'Produk'; card.appendChild(h3);

      const priceDiv = document.createElement('div'); priceDiv.className='price';
      const old = document.createElement('span'); old.className='old'; old.textContent = 'Rp ' + fmtRupiah(p.hargaawal);
      const neu = document.createElement('span'); neu.className='new'; neu.textContent = 'Rp ' + fmtRupiah(p.hargadiskon || p.hargaawal);
      priceDiv.appendChild(old); priceDiv.appendChild(neu);
      card.appendChild(priceDiv);

      const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Tambah ke Keranjang';
      btn.addEventListener('click', ()=> {
        // add minimal product object
        addToCart({id:card.dataset.id, nama:card.dataset.name, hargaawal:p.hargaawal, hargadiskon:p.hargadiskon});
      });
      card.appendChild(btn);

      grid.appendChild(card);
    });

    // initial countdowns
    updateCountdowns();
  }

  function renderGallery(){
    const g = $('#galleryGrid'); g.innerHTML='';
    if(!GALLERY.length) GALLERY=[{url:'https://via.placeholder.com/1000x700?text=Gallery', alt:'Galeri'}];
    GALLERY.forEach(it=>{
      const slide = document.createElement('div'); slide.className='swiper-slide gallery-item';
      slide.innerHTML = `<img src="${it.url||''}" alt="${escapeHtml(it.alt||'')}" loading="lazy" data-zoom="1">`;
      g.appendChild(slide);
    });
  }
  function renderTesti(){
    const t = $('#testiGrid'); t.innerHTML='';
    if(!TESTIS.length) TESTIS=[{nama:'Budi', jabatan:'Pelanggan', gambar:'https://via.placeholder.com/600x400?text=User'}];
    TESTIS.forEach(it=>{
      const slide = document.createElement('div'); slide.className='swiper-slide';
      slide.innerHTML = `<div class="testimonial-card"><img src="${it.gambar||''}" alt="${escapeHtml(it.nama||'')}" loading="lazy"><p><strong>${escapeHtml(it.nama||'')}</strong><br><small>${escapeHtml(it.jabatan||'')}</small></p></div>`;
      t.appendChild(slide);
    });
  }

  // init swipers
  function initSwipers(){
    // hero full height, maximize
    if(heroSwiper) heroSwiper.destroy(true,true);
    heroSwiper = new Swiper('#swiperHero', {
      loop:true,
      autoplay:{delay:4500,disableOnInteraction:false},
      pagination:{el:'#swiperHero .swiper-pagination',clickable:true},
      navigation:{nextEl:'#swiperHero .swiper-button-next',prevEl:'#swiperHero .swiper-button-prev'},
      effect:'slide',
      grabCursor:true,
      keyboard:{enabled:true}
    });

    // gallery
    if(gallerySwiper) gallerySwiper.destroy(true,true);
    gallerySwiper = new Swiper('#gallerySwiper', {
      slidesPerView:1.1,spaceBetween:12,loop:true,
      breakpoints:{640:{slidesPerView:2.2},900:{slidesPerView:3.2}},
      pagination:{el:'#gallerySwiper .swiper-pagination',clickable:true},
      grabCursor:true
    });

    // testi
    if(testiSwiper) testiSwiper.destroy(true,true);
    testiSwiper = new Swiper('#testiSwiper', {
      slidesPerView:1.05,spaceBetween:12,loop:true,
      breakpoints:{640:{slidesPerView:2.0},900:{slidesPerView:3.0}},
      pagination:{el:'#testiSwiper .swiper-pagination',clickable:true},
      grabCursor:true
    });
  }

  // promo countdown logic (reads data-start & data-end on card)
  function updateCountdowns(){
    const cards = $$('#productsGrid .card');
    let anyPromo=false;
    const now = new Date();
    const nowMin = now.getHours()*60 + now.getMinutes();

    cards.forEach(card=>{
      const co = $('.countdown-overlay', card);
      const label = $('.promo-label', card);
      const oldEl = $('.old', card);
      const newEl = $('.new', card);
      const start = card.dataset.start || '';
      const end = card.dataset.end || '';
      const hargaAwal = card.dataset.hargaawal || '';
      const hargaDiskon = card.dataset.hargadiskon || '';

      if(!start || !end){
        if(co) co.style.display='none';
        if(label) label.style.display='none';
        if(oldEl) oldEl.style.display='none';
        if(newEl) newEl.textContent = 'Rp ' + fmtRupiah(hargaAwal || hargaDiskon);
        return;
      }

      const sMin = hmToMinutes(start);
      const eMin = hmToMinutes(end);
      if(sMin==null || eMin==null){ if(co) co.style.display='none'; if(label) label.style.display='none'; return; }

      let active=false; let secondsLeft=0;
      if(eMin < sMin){
        if(nowMin >= sMin || nowMin <= eMin){
          active=true;
          const endDate = new Date();
          if(nowMin >= sMin) endDate.setDate(endDate.getDate()+1);
          const ep = parseHM(end); endDate.setHours(ep.h, ep.m, 0, 0);
          secondsLeft = Math.floor((endDate - new Date())/1000);
        }
      } else {
        if(nowMin >= sMin && nowMin <= eMin){
          active=true;
          const endDate = new Date(); const ep = parseHM(end); endDate.setHours(ep.h, ep.m, 0, 0);
          secondsLeft = Math.floor((endDate - new Date())/1000);
        }
      }

      if(active){
        anyPromo=true;
        if(co){ co.textContent = formatCountdown(secondsLeft); co.style.display='block'; }
        if(label) label.style.display='inline-block';
        if(oldEl) oldEl.style.display = (hargaDiskon ? 'inline-block' : 'none');
        if(newEl) newEl.textContent = 'Rp ' + fmtRupiah(hargaDiskon || hargaAwal);
      } else {
        if(co) co.style.display='none';
        if(label) label.style.display='none';
        if(oldEl) oldEl.style.display='none';
        if(newEl) newEl.textContent = 'Rp ' + fmtRupiah(hargaAwal || hargaDiskon);
      }
    });

    $('#promo-bar').style.display = anyPromo ? 'block' : 'none';
  }
  function formatCountdown(sec){
    if(sec<=0) return '00:00:00';
    const h = Math.floor(sec/3600); const m = Math.floor((sec%3600)/60); const s = Math.floor(sec%60);
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }
  function pad(n){ return (n<10? '0':'') + n; }
  function hmToMinutes(hm){ if(!hm) return null; const p=String(hm).split(':'); if(p.length<2) return null; const hh=parseInt(p[0],10), mm=parseInt(p[1],10); if(isNaN(hh)||isNaN(mm)) return null; return hh*60+mm; }
  function parseHM(s){ if(!s) return null; const p=String(s).split(':'); return {h:parseInt(p[0],10), m:parseInt(p[1],10)}; }

  // cart logic
  function addToCart(item){
    // item must have id,name,price (price numeric)
    const id = item.id || ('id-'+Math.random().toString(36).slice(2,8));
    const price = Number(String(item.hargadiskon || item.hargaawal || item.price || 0).replace(/\D/g,'')) || 0;
    const name = item.nama || item.name || item.title || 'Produk';
    const existing = cart.find(c=>c.id===id);
    if(existing) existing.qty++;
    else cart.push({id,name,price,qty:1});
    updateCartUI();
  }

  function updateCartUI(){
    const count = cart.reduce((s,i)=>s + (i.qty||0),0);
    const badge = $('#cartBadge');
    if(count>0){ badge.style.display='inline-block'; badge.textContent = count; } else badge.style.display='none';
    renderCartPanel();
  }

  function renderCartPanel(){
    const list = $('#cartItemsList');
    list.innerHTML = '';
    if(cart.length===0){ list.innerHTML = '<p>Keranjang kosong</p>'; $('#cartTotal').textContent = 'Rp 0'; return; }
    let total=0;
    cart.forEach(item=>{
      total += item.price * item.qty;
      const row = document.createElement('div'); row.className='cart-item';
      row.innerHTML = `<div style="max-width:62%"><div style="font-weight:800">${escapeHtml(item.name)}</div><div style="font-size:.9rem;color:var(--muted)">Rp ${fmtRupiah(item.price)} / pcs</div></div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="qty-controls" data-id="${item.id}">
            <button class="qty-minus" aria-label="kurangi">‚àí</button>
            <span class="qty-count" style="font-weight:800">${item.qty}</span>
            <button class="qty-plus" aria-label="tambah">+</button>
          </div>
        </div>`;
      list.appendChild(row);
    });
    $('#cartTotal').textContent = 'Rp ' + fmtRupiah(total);

    // persistent event delegation (works for dynamic content). Remove previous to avoid duplicates.
    list.removeEventListener('click', onCartListClick);
    list.addEventListener('click', onCartListClick);
  }

  function onCartListClick(e){
    const minus = e.target.closest('.qty-minus');
    const plus = e.target.closest('.qty-plus');
    if(minus || plus){
      const ctrl = e.target.closest('.qty-controls');
      if(!ctrl) return;
      const id = ctrl.dataset.id;
      const item = cart.find(x=>x.id===id);
      if(!item) return;
      if(minus) item.qty = Math.max(0, item.qty - 1);
      if(plus) item.qty = item.qty + 1;
      if(item.qty === 0) cart = cart.filter(x=>x.id!==id);
      updateCartUI();
    }
  }

  // UI setup
  function setupUI(){
    // offcanvas menu mobile
    const menuToggle = $('#menuToggle'); const off = $('#offcanvasLeft'); const offClose = $('#offLeftClose');
    menuToggle.addEventListener('click', ()=> { off.style.display='block'; off.classList.add('active'); off.setAttribute('aria-hidden','false'); });
    offClose.addEventListener('click', ()=> { off.classList.remove('active'); setTimeout(()=> off.style.display='none',250); });
    $$('.off-link').forEach(a=> a.addEventListener('click', ()=> { off.classList.remove('active'); setTimeout(()=> off.style.display='none',250); }));

    // cart panel
    $('#cartFloatBtn').addEventListener('click', ()=> { $('#cartPanel').classList.add('active'); $('#cartPanel').setAttribute('aria-hidden','false'); renderCartPanel(); });
    $('#closeCartPanel').addEventListener('click', ()=> { $('#cartPanel').classList.remove('active'); $('#cartPanel').setAttribute('aria-hidden','true'); });
    $('#clearCart').addEventListener('click', ()=> { cart = []; updateCartUI(); });

    // checkout (uses settings wa)
    $('#checkoutBtn').addEventListener('click', ()=> {
      if(!SETTINGS.wa){ alert('Nomor WhatsApp belum diset di Pengaturan.'); return; }
      let msg = 'Saya ingin memesan:%0A';
      cart.forEach(i=> msg += `- ${i.name} x${i.qty} (Rp ${fmtRupiah(i.price*i.qty)})%0A`);
      window.open(`https://wa.me/${SETTINGS.wa}?text=${msg}`,'_blank');
    });

    // dark mode toggle
    $('#darkToggle').addEventListener('click', ()=>{
      const on = document.body.classList.toggle('dark');
      localStorage.setItem('dark', on ? '1' : '0');
    });

    // restore dark
    if(localStorage.getItem('dark') === '1') document.body.classList.add('dark');

    // scroll top
    const scrollTopBtn = $('#scrollTopBtn');
    scrollTopBtn.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
    // show/hide scroll button
    window.addEventListener('scroll', ()=> {
      if(window.scrollY > 300) scrollTopBtn.style.display = 'flex'; else scrollTopBtn.style.display = 'none';
    });
    // initially hide
    scrollTopBtn.style.display = 'none';

    // zoom: open overlay when clicking images with data-zoom attr
    document.body.addEventListener('click', (e)=>{
      const img = e.target.closest('img[data-zoom]');
      if(!img) return;
      openZoom(img.src);
    });

    // zoom controls
    $('#zoomClose').addEventListener('click', closeZoom);
    $('#zoomIn').addEventListener('click', ()=> changeZoom(1.2));
    $('#zoomOut').addEventListener('click', ()=> changeZoom(1/1.2));
    $('#zoomReset').addEventListener('click', ()=> { zoomScale = 1; translateX = translateY = 0; applyZoom(); });

    // close zoom on ESC
    document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closeZoom(); });
  }

  // zoom implementation (simple)
  let zoomScale = 1, translateX = 0, translateY = 0, dragging=false, startX=0, startY=0;
  function openZoom(src){
    const ov = $('#zoomOverlay'), zi = $('#zoomImg');
    zi.src = src; zoomScale = 1; translateX = translateY = 0; applyZoom();
    ov.classList.add('show'); ov.style.display='flex'; ov.setAttribute('aria-hidden','false');
    // pointer handlers for drag
    zi.style.cursor = 'grab';
    zi.onpointerdown = function(e){ dragging=true; startX=e.clientX; startY=e.clientY; zi.setPointerCapture(e.pointerId); zi.style.cursor='grabbing'; };
    zi.onpointermove = function(e){ if(!dragging) return; translateX += (e.clientX - startX); translateY += (e.clientY - startY); startX = e.clientX; startY = e.clientY; applyZoom(); };
    zi.onpointerup = zi.onpointercancel = function(){ dragging=false; zi.releasePointerCapture && zi.releasePointerCapture(); zi.style.cursor='grab'; };
    // wheel zoom
    ov.onwheel = function(e){ e.preventDefault(); const delta = e.deltaY < 0 ? 1.06 : 0.94; zoomScale = Math.max(1, Math.min(5, zoomScale * delta)); applyZoom(); };
  }
  function applyZoom(){ const zi = $('#zoomImg'); zi.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomScale})`; }
  function closeZoom(){ const ov = $('#zoomOverlay'); ov.classList.remove('show'); ov.style.display='none'; $('#zoomImg').src=''; }
  function changeZoom(factor){ zoomScale = Math.max(1, Math.min(5, zoomScale * factor)); applyZoom(); }

  // utilities
  function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // data load and init
  (async function init(){
    try{
      // show loading
      loadingEl.style.display = 'flex';

      // fetch settings first
      const settingsRows = await fetchSheet('Pengaturan').catch(()=>[]);
      const settingsMap = mapRows(settingsRows);
      applySettings(settingsMap);

      // fetch data in parallel
      const [slidesR, productsR, galleryR, testiR] = await Promise.all([
        fetchSheet('Slider').catch(()=>[]),
        fetchSheet('Produk').catch(()=>[]),
        fetchSheet('Galeri').catch(()=>[]),
        fetchSheet('Testimoni').catch(()=>[])
      ]);
      SLIDES = nmSlides(slidesR);
      PRODUCTS = nmProducts(productsR);
      GALLERY = nmGallery(galleryR);
      TESTIS = nmTesti(testiR);

      // render
      renderHero();
      renderProducts();
      renderGallery();
      renderTesti();

      // UI and swipers
      setupUI();
      setTimeout(()=> initSwipers(), 180); // slight delay to ensure DOM layout
      // countdown intervals
      setInterval(updateCountdowns, 1000);

      // attach cart float / wa links from settings if present
      if(SETTINGS.wa) { $('#whatsappFloat').href = `https://wa.me/${SETTINGS.wa}`; $('#whatsappFloat').setAttribute('target','_blank'); $('#whatsappFloat').rel='noopener'; }

      // hide loader shortly after
      setTimeout(()=> loadingEl.style.display='none', 250);
    }catch(err){
      console.error('Init error', err);
      // still try to init UI using fallback HTML
      setupUI();
      initSwipers();
      setTimeout(()=> loadingEl.style.display='none', 300);
    }
  })();

  /***** small helper for safely calling parseInt in template *****/
  function parseIntSafe(v){ const n=Number(String(v).replace(/\D/g,'')); return isNaN(n)?0:n; }
  </script>
</body>
</html>
